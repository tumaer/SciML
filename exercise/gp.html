

<!DOCTYPE html>


<html lang="en" data-content_root="" >

  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" /><meta name="generator" content="Docutils 0.17.1: http://docutils.sourceforge.net/" />

    <title>5. Gaussian Processes &#8212; Introduction to Scientific Machine Learning for Engineers</title>
  
  
  
  <script data-cfasync="false">
    document.documentElement.dataset.mode = localStorage.getItem("mode") || "";
    document.documentElement.dataset.theme = localStorage.getItem("theme") || "light";
  </script>
  
  <!-- Loaded before other Sphinx assets -->
  <link href="../_static/styles/theme.css?digest=5b4479735964841361fd" rel="stylesheet" />
<link href="../_static/styles/bootstrap.css?digest=5b4479735964841361fd" rel="stylesheet" />
<link href="../_static/styles/pydata-sphinx-theme.css?digest=5b4479735964841361fd" rel="stylesheet" />

  
  <link href="../_static/vendor/fontawesome/6.1.2/css/all.min.css?digest=5b4479735964841361fd" rel="stylesheet" />
  <link rel="preload" as="font" type="font/woff2" crossorigin href="../_static/vendor/fontawesome/6.1.2/webfonts/fa-solid-900.woff2" />
<link rel="preload" as="font" type="font/woff2" crossorigin href="../_static/vendor/fontawesome/6.1.2/webfonts/fa-brands-400.woff2" />
<link rel="preload" as="font" type="font/woff2" crossorigin href="../_static/vendor/fontawesome/6.1.2/webfonts/fa-regular-400.woff2" />

    <link rel="stylesheet" type="text/css" href="../_static/pygments.css" />
    <link rel="stylesheet" href="../_static/styles/sphinx-book-theme.css?digest=14f4ca6b54d191a8c7657f6c759bf11a5fb86285" type="text/css" />
    <link rel="stylesheet" type="text/css" href="../_static/togglebutton.css" />
    <link rel="stylesheet" type="text/css" href="../_static/copybutton.css" />
    <link rel="stylesheet" type="text/css" href="../_static/mystnb.4510f1fc1dee50b3e5859aac5469c37c29e427902b24a333a5f9fcb2f0b3ac41.css" />
    <link rel="stylesheet" type="text/css" href="../_static/sphinx-thebe.css" />
    <link rel="stylesheet" type="text/css" href="../_static/design-style.4045f2051d55cab465a707391d5b2007.min.css" />
  
  <!-- Pre-loaded scripts that we'll load fully later -->
  <link rel="preload" as="script" href="../_static/scripts/bootstrap.js?digest=5b4479735964841361fd" />
<link rel="preload" as="script" href="../_static/scripts/pydata-sphinx-theme.js?digest=5b4479735964841361fd" />
  <script src="../_static/vendor/fontawesome/6.1.2/js/all.min.js?digest=5b4479735964841361fd"></script>

    <script data-url_root="../" id="documentation_options" src="../_static/documentation_options.js"></script>
    <script src="../_static/jquery.js"></script>
    <script src="../_static/underscore.js"></script>
    <script src="../_static/_sphinx_javascript_frameworks_compat.js"></script>
    <script src="../_static/doctools.js"></script>
    <script src="../_static/clipboard.min.js"></script>
    <script src="../_static/copybutton.js"></script>
    <script src="../_static/scripts/sphinx-book-theme.js?digest=5a5c038af52cf7bc1a1ec88eea08e6366ee68824"></script>
    <script>let toggleHintShow = 'Click to show';</script>
    <script>let toggleHintHide = 'Click to hide';</script>
    <script>let toggleOpenOnPrint = 'true';</script>
    <script src="../_static/togglebutton.js"></script>
    <script>var togglebuttonSelector = '.toggle, .admonition.dropdown';</script>
    <script src="../_static/design-tabs.js"></script>
    <script>const THEBE_JS_URL = "https://unpkg.com/thebe@0.8.2/lib/index.js"
const thebe_selector = ".thebe,.cell"
const thebe_selector_input = "pre"
const thebe_selector_output = ".output, .cell_output"
</script>
    <script async="async" src="../_static/sphinx-thebe.js"></script>
    <script>window.MathJax = {"options": {"processHtmlClass": "tex2jax_process|mathjax_process|math|output_area"}}</script>
    <script defer="defer" src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js"></script>
    <script>DOCUMENTATION_OPTIONS.pagename = 'exercise/gp';</script>
    <link rel="author" title="About these documents" href="../about.html" />
    <link rel="index" title="Index" href="../genindex.html" />
    <link rel="search" title="Search" href="../search.html" />
    <link rel="next" title="6. Convolutional Neural Networks" href="cnn.html" />
    <link rel="prev" title="4. Support Vector Machines" href="svm.html" />
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <meta name="docsearch:language" content="en"/>
  </head>
  
  
  <body data-bs-spy="scroll" data-bs-target=".bd-toc-nav" data-offset="180" data-bs-root-margin="0px 0px -60%" data-default-mode="">

  
  
  <a class="skip-link" href="#main-content">Skip to main content</a>
  
  <div id="pst-scroll-pixel-helper"></div>

  
  <button type="button" class="btn rounded-pill" id="pst-back-to-top">
    <i class="fa-solid fa-arrow-up"></i>
    Back to top
  </button>

  
  <input type="checkbox"
          class="sidebar-toggle"
          name="__primary"
          id="__primary"/>
  <label class="overlay overlay-primary" for="__primary"></label>
  
  <input type="checkbox"
          class="sidebar-toggle"
          name="__secondary"
          id="__secondary"/>
  <label class="overlay overlay-secondary" for="__secondary"></label>
  
  <div class="search-button__wrapper">
    <div class="search-button__overlay"></div>
    <div class="search-button__search-container">
<form class="bd-search d-flex align-items-center"
      action="../search.html"
      method="get">
  <i class="fa-solid fa-magnifying-glass"></i>
  <input type="search"
         class="form-control"
         name="q"
         id="search-input"
         placeholder="Search this book..."
         aria-label="Search this book..."
         autocomplete="off"
         autocorrect="off"
         autocapitalize="off"
         spellcheck="false"/>
  <span class="search-button__kbd-shortcut"><kbd class="kbd-shortcut__modifier">Ctrl</kbd>+<kbd>K</kbd></span>
</form></div>
  </div>
  
    <nav class="bd-header navbar navbar-expand-lg bd-navbar">
    </nav>
  
  <div class="bd-container">
    <div class="bd-container__inner bd-page-width">
      
      <div class="bd-sidebar-primary bd-sidebar">
        

  
  <div class="sidebar-header-items sidebar-primary__section">
    
    
    
    
  </div>
  
    <div class="sidebar-primary-items__start sidebar-primary__section">
        <div class="sidebar-primary-item">

  

<a class="navbar-brand logo" href="../about.html">
  
  
  
  
  
    
    
      
    
    
    <img src="../_static/logo.png" class="logo__image only-light" alt="Introduction to Scientific Machine Learning for Engineers - Home"/>
    <script>document.write(`<img src="../_static/logo.png" class="logo__image only-dark" alt="Introduction to Scientific Machine Learning for Engineers - Home"/>`);</script>
  
  
</a></div>
        <div class="sidebar-primary-item"><nav class="bd-links" id="bd-docs-nav" aria-label="Main">
    <div class="bd-toc-item navbar-nav active">
        
        <ul class="nav bd-sidenav bd-sidenav__home-link">
            <li class="toctree-l1">
                <a class="reference internal" href="../about.html">
                    About this Lecture
                </a>
            </li>
        </ul>
        <ul class="nav bd-sidenav">
<li class="toctree-l1"><a class="reference internal" href="../introduction.html">Introduction</a></li>
</ul>
<p aria-level="2" class="caption" role="heading"><span class="caption-text">Lecture</span></p>
<ul class="nav bd-sidenav">
<li class="toctree-l1"><a class="reference internal" href="../lecture/linear.html">1. Linear Models</a></li>
<li class="toctree-l1"><a class="reference internal" href="../lecture/gmm.html">2. Gaussian Mixture Models</a></li>
<li class="toctree-l1"><a class="reference internal" href="../lecture/bayes.html">3. Bayesian methods</a></li>
<li class="toctree-l1"><a class="reference internal" href="../lecture/optimization.html">4. Optimization</a></li>
<li class="toctree-l1"><a class="reference internal" href="../lecture/tricks.html">5. Tricks of Optimization</a></li>
<li class="toctree-l1"><a class="reference internal" href="../lecture/svm.html">6. Support Vector Machines</a></li>
<li class="toctree-l1"><a class="reference internal" href="../lecture/gp.html">7. Gaussian Processes</a></li>
<li class="toctree-l1"><a class="reference internal" href="../lecture/gradients.html">8. Gradients</a></li>
<li class="toctree-l1"><a class="reference internal" href="../lecture/mlp.html">9. Multilayer Perceptron</a></li>
<li class="toctree-l1"><a class="reference internal" href="../lecture/cnn.html">10. Convolutional Neural Networks</a></li>
<li class="toctree-l1"><a class="reference internal" href="../lecture/rnn.html">11. Recurrent Models</a></li>
<li class="toctree-l1"><a class="reference internal" href="../lecture/ae.html">12. Encoder-Decoder Models</a></li>
</ul>
<p aria-level="2" class="caption" role="heading"><span class="caption-text">Exercise</span></p>
<ul class="current nav bd-sidenav">
<li class="toctree-l1"><a class="reference internal" href="linear.html">1. Linear and Logistic Regression</a></li>
<li class="toctree-l1"><a class="reference internal" href="bayes.html">2. Bayesian Linear Models</a></li>
<li class="toctree-l1"><a class="reference internal" href="optimization.html">3. Optimization</a></li>
<li class="toctree-l1"><a class="reference internal" href="svm.html">4. Support Vector Machines</a></li>
<li class="toctree-l1 current active"><a class="current reference internal" href="#">5. Gaussian Processes</a></li>
<li class="toctree-l1"><a class="reference internal" href="cnn.html">6. Convolutional Neural Networks</a></li>
<li class="toctree-l1"><a class="reference internal" href="rnn.html">7. Recurrent Neural Networks</a></li>
</ul>
<p aria-level="2" class="caption" role="heading"><span class="caption-text">Miscellaneous</span></p>
<ul class="nav bd-sidenav">
<li class="toctree-l1"><a class="reference internal" href="../admin.html">Admin</a></li>
<li class="toctree-l1"><a class="reference internal" href="../books.html">Books</a></li>
<li class="toctree-l1"><a class="reference internal" href="../references.html">References</a></li>
<li class="toctree-l1"><a class="reference internal" href="../preliminary_knowledge.html">Preliminary Knowledge</a></li>
<li class="toctree-l1"><a class="reference internal" href="../software.html">Software Infrastructure</a></li>
<li class="toctree-l1"><a class="reference internal" href="../practical_exam.html">Practical Exam WS22/23</a></li>
<li class="toctree-l1"><a class="reference internal" href="../faq.html">Frequently Asked Questions</a></li>
</ul>

    </div>
</nav></div>
    </div>
  
  
  <div class="sidebar-primary-items__end sidebar-primary__section">
  </div>
  
  <div id="rtd-footer-container"></div>


      </div>
      
      <main id="main-content" class="bd-main">
        
        

<div class="sbt-scroll-pixel-helper"></div>

          <div class="bd-content">
            <div class="bd-article-container">
              
              <div class="bd-header-article">
<div class="header-article-items header-article__inner">
  
    <div class="header-article-items__start">
      
        <div class="header-article-item"><label class="sidebar-toggle primary-toggle btn btn-sm" for="__primary" title="Toggle primary sidebar" data-bs-placement="bottom" data-bs-toggle="tooltip">
  <span class="fa-solid fa-bars"></span>
</label></div>
      
    </div>
  
  
    <div class="header-article-items__end">
      
        <div class="header-article-item">

<div class="article-header-buttons">





<div class="dropdown dropdown-launch-buttons">
  <button class="btn dropdown-toggle" type="button" data-bs-toggle="dropdown" aria-expanded="false" aria-label="Launch interactive content">
    <i class="fas fa-rocket"></i>
  </button>
  <ul class="dropdown-menu">
      
      
      
      <li><a href="https://colab.research.google.com/github/tumaer/SciML/blob/master/exercise/gp.ipynb" target="_blank"
   class="btn btn-sm dropdown-item"
   title="Launch onColab"
   data-bs-placement="left" data-bs-toggle="tooltip"
>
  

<span class="btn__icon-container">
  
    <img src="../_static/images/logo_colab.png">
  </span>
<span class="btn__text-container">Colab</span>
</a>
</li>
      
  </ul>
</div>






<div class="dropdown dropdown-source-buttons">
  <button class="btn dropdown-toggle" type="button" data-bs-toggle="dropdown" aria-expanded="false" aria-label="Source repositories">
    <i class="fab fa-github"></i>
  </button>
  <ul class="dropdown-menu">
      
      
      
      <li><a href="https://github.com/tumaer/SciML" target="_blank"
   class="btn btn-sm btn-source-repository-button dropdown-item"
   title="Source repository"
   data-bs-placement="left" data-bs-toggle="tooltip"
>
  

<span class="btn__icon-container">
  <i class="fab fa-github"></i>
  </span>
<span class="btn__text-container">Repository</span>
</a>
</li>
      
      
      
      
      <li><a href="https://github.com/tumaer/SciML/issues/new?title=Issue%20on%20page%20%2Fexercise/gp.html&body=Your%20issue%20content%20here." target="_blank"
   class="btn btn-sm btn-source-issues-button dropdown-item"
   title="Open an issue"
   data-bs-placement="left" data-bs-toggle="tooltip"
>
  

<span class="btn__icon-container">
  <i class="fas fa-lightbulb"></i>
  </span>
<span class="btn__text-container">Open issue</span>
</a>
</li>
      
  </ul>
</div>






<div class="dropdown dropdown-download-buttons">
  <button class="btn dropdown-toggle" type="button" data-bs-toggle="dropdown" aria-expanded="false" aria-label="Download this page">
    <i class="fas fa-download"></i>
  </button>
  <ul class="dropdown-menu">
      
      
      
      <li><a href="../_sources/exercise/gp.ipynb" target="_blank"
   class="btn btn-sm btn-download-source-button dropdown-item"
   title="Download source file"
   data-bs-placement="left" data-bs-toggle="tooltip"
>
  

<span class="btn__icon-container">
  <i class="fas fa-file"></i>
  </span>
<span class="btn__text-container">.ipynb</span>
</a>
</li>
      
      
      
      
      <li>
<button onclick="window.print()"
  class="btn btn-sm btn-download-pdf-button dropdown-item"
  title="Print to PDF"
  data-bs-placement="left" data-bs-toggle="tooltip"
>
  

<span class="btn__icon-container">
  <i class="fas fa-file-pdf"></i>
  </span>
<span class="btn__text-container">.pdf</span>
</button>
</li>
      
  </ul>
</div>




<button onclick="toggleFullScreen()"
  class="btn btn-sm btn-fullscreen-button"
  title="Fullscreen mode"
  data-bs-placement="bottom" data-bs-toggle="tooltip"
>
  

<span class="btn__icon-container">
  <i class="fas fa-expand"></i>
  </span>

</button>



<script>
document.write(`
  <button class="btn btn-sm navbar-btn theme-switch-button" title="light/dark" aria-label="light/dark" data-bs-placement="bottom" data-bs-toggle="tooltip">
    <span class="theme-switch nav-link" data-mode="light"><i class="fa-solid fa-sun fa-lg"></i></span>
    <span class="theme-switch nav-link" data-mode="dark"><i class="fa-solid fa-moon fa-lg"></i></span>
    <span class="theme-switch nav-link" data-mode="auto"><i class="fa-solid fa-circle-half-stroke fa-lg"></i></span>
  </button>
`);
</script>


<script>
document.write(`
  <button class="btn btn-sm navbar-btn search-button search-button__button" title="Search" aria-label="Search" data-bs-placement="bottom" data-bs-toggle="tooltip">
    <i class="fa-solid fa-magnifying-glass fa-lg"></i>
  </button>
`);
</script>
<label class="sidebar-toggle secondary-toggle btn btn-sm" for="__secondary"title="Toggle secondary sidebar" data-bs-placement="bottom" data-bs-toggle="tooltip">
    <span class="fa-solid fa-list"></span>
</label>
</div></div>
      
    </div>
  
</div>
</div>
              
              

<div id="jb-print-docs-body" class="onlyprint">
    <h1>Gaussian Processes</h1>
    <!-- Table of contents -->
    <div id="print-main-content">
        <div id="jb-print-toc">
            
            <div>
                <h2> Contents </h2>
            </div>
            <nav aria-label="Page">
                <ul class="visible nav section-nav flex-column">
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#tl-dr-of-gaussian-process-theory">5.1. Tl;dr of Gaussian Process Theory</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#gaussian-processes-from-sketch">5.2. Gaussian Processes from Sketch</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#gaussian-processes-in-pyro">5.3. Gaussian Processes in Pyro</a><ul class="nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#helper-function-for-plotting">5.3.1. Helper Function for Plotting</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#synthetic-dataset">5.3.2. Synthetic Dataset</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#model-definition">5.3.3. Model Definition</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#inference">5.3.4. Inference</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#maximum-a-posteriory-estimation-map">5.3.5. Maximum a Posteriory Estimation (MAP)</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#gaussian-process-classification">5.3.6. Gaussian Process Classification</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#gaussian-process-classification-the-tl-dr">5.3.7. Gaussian Process Classification: The tl;dr</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#combining-kernels">5.3.8. Combining Kernels</a></li>
</ul>
</li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#remarks">5.4. Remarks</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#tasks">5.5. Tasks</a></li>
</ul>
            </nav>
        </div>
    </div>
</div>

              
                
<div id="searchbox"></div>
                <article class="bd-article" role="main">
                  
  <section class="tex2jax_ignore mathjax_ignore" id="gaussian-processes">
<h1><span class="section-number">5. </span>Gaussian Processes<a class="headerlink" href="#gaussian-processes" title="Permalink to this heading">#</a></h1>
<p>At the end of this exercise you will be more familiar with Gaussian Processes and the way they work in practice, as well as how you can adapt them to your problems (such as the ones on the mock exam)</p>
<ul class="simple">
<li><p>Training Setup</p></li>
<li><p>GP Regression</p></li>
<li><p>GP Classification</p></li>
</ul>
<p>The main reference to this exercise is the <a class="reference external" href="https://pyro.ai/examples/gp.html">Pyro tutorial on Gaussian Processes</a>.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">torch</span>
<span class="kn">import</span> <span class="nn">torch.nn</span> <span class="k">as</span> <span class="nn">nn</span>
<span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>

<span class="c1"># visualization</span>
<span class="kn">import</span> <span class="nn">matplotlib.pyplot</span> <span class="k">as</span> <span class="nn">plt</span>
<span class="kn">from</span> <span class="nn">matplotlib.animation</span> <span class="kn">import</span> <span class="n">FuncAnimation</span>
<span class="kn">import</span> <span class="nn">seaborn</span> <span class="k">as</span> <span class="nn">sns</span>
<span class="kn">from</span> <span class="nn">sklearn.metrics</span> <span class="kn">import</span> <span class="n">confusion_matrix</span><span class="p">,</span> <span class="n">ConfusionMatrixDisplay</span>

<span class="n">torch</span><span class="o">.</span><span class="n">set_default_dtype</span><span class="p">(</span><span class="n">torch</span><span class="o">.</span><span class="n">float64</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<section id="tl-dr-of-gaussian-process-theory">
<h2><span class="section-number">5.1. </span>Tl;dr of Gaussian Process Theory<a class="headerlink" href="#tl-dr-of-gaussian-process-theory" title="Permalink to this heading">#</a></h2>
<p>Why GPs?</p>
<ul class="simple">
<li><p>Elegant mathematical theory which affords us guarantees for our predictive modelâ€™s behaviour</p></li>
<li><p>Conceptually, they give us a way to define priors over functions</p></li>
<li><p>Are able to reason over uncertainty as they are rooted in the Bayesian setting</p></li>
</ul>
<p>As GPs do in practice require a tiny bit of infrastructure below them to work, and be efficient, we will rely on <a class="reference external" href="https://github.com/pyro-ppl/pyro">Pyro</a> to provide us with the required abstractions. Our model is defined as</p>
<div class="math notranslate nohighlight">
\[
f \sim \mathcal{GP}\left( 0, \text{K}_{f}(x, x') \right)
\]</div>
<p>with our presumed data following the relationship</p>
<div class="math notranslate nohighlight">
\[
y = f(x) + \varepsilon, \quad \varepsilon \sim \mathcal{N}(0, \beta^{-1} \textbf{I})
\]</div>
<p>where <span class="math notranslate nohighlight">\(x\)</span>, <span class="math notranslate nohighlight">\(x'\)</span> are points in the input space, and y is a point in the output space. <span class="math notranslate nohighlight">\(f\)</span> then represents a function from the input space to the output space in which we <strong>draw</strong> from the Gaussian Process prior specified by the mean, and the kernel.</p>
<p>As already mentioned in the lecture, the radial basis function is one of the most common kernels and one which you have probably by now also encountered in use with Support Vector Machines:</p>
<div class="math notranslate nohighlight">
\[
k(x, x'|\sigma, l) = \sigma^{2} \text{exp} \left( - \frac{|| x - x' ||^{2}}{2 l^{2}}  \right)
\]</div>
<p>where the variance <span class="math notranslate nohighlight">\(\sigma^{2}\)</span>, and lengthscale <span class="math notranslate nohighlight">\(l\)</span> are kernel specification parameters.</p>
</section>
<section id="gaussian-processes-from-sketch">
<h2><span class="section-number">5.2. </span>Gaussian Processes from Sketch<a class="headerlink" href="#gaussian-processes-from-sketch" title="Permalink to this heading">#</a></h2>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">class</span> <span class="nc">GaussianProcess</span><span class="p">(</span><span class="n">nn</span><span class="o">.</span><span class="n">Module</span><span class="p">):</span>

<span class="w">    </span><span class="sd">&quot;&quot;&quot;Gaussian process regression model.</span>

<span class="sd">    Built for multi-input, single-output functions.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">kernel</span><span class="p">,</span> <span class="n">sigma_n</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">eps</span><span class="o">=</span><span class="mf">1e-6</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Constructs an instance of a Gaussian process.</span>

<span class="sd">        Args:</span>
<span class="sd">            kernel (Kernel): Kernel</span>
<span class="sd">            sigma_n (Tensor): Noise standard deviation</span>
<span class="sd">            eps (Float): Minimum bound for parameters.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="nb">super</span><span class="p">(</span><span class="n">GaussianProcess</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="fm">__init__</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">kernel</span> <span class="o">=</span> <span class="n">kernel</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">sigma_n</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">nn</span><span class="o">.</span><span class="n">Parameter</span><span class="p">(</span>
            <span class="n">torch</span><span class="o">.</span><span class="n">randn</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span> <span class="k">if</span> <span class="n">sigma_n</span> <span class="ow">is</span> <span class="kc">None</span> <span class="k">else</span> <span class="n">sigma_n</span>
        <span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_eps</span> <span class="o">=</span> <span class="n">eps</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_is_set</span> <span class="o">=</span> <span class="kc">False</span>

    <span class="k">def</span> <span class="nf">_update_k</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Update the K matrix.&quot;&quot;&quot;</span>
        <span class="n">X</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_X</span>
        <span class="n">Y</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_Y</span>

        <span class="c1"># Compute K and guarantee it is positive definite</span>
        <span class="n">var_n</span> <span class="o">=</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">sigma_n</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span><span class="o">.</span><span class="n">clamp</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_eps</span><span class="p">,</span> <span class="mf">1e5</span><span class="p">)</span>
        <span class="n">K</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">kernel</span><span class="p">(</span><span class="n">X</span><span class="p">,</span> <span class="n">X</span><span class="p">)</span>
        <span class="n">K</span> <span class="o">=</span> <span class="p">(</span><span class="n">K</span> <span class="o">+</span> <span class="n">K</span><span class="o">.</span><span class="n">t</span><span class="p">())</span><span class="o">.</span><span class="n">mul</span><span class="p">(</span><span class="mf">0.5</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_K</span> <span class="o">=</span> <span class="n">K</span> <span class="o">+</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_reg</span> <span class="o">+</span> <span class="n">var_n</span><span class="p">)</span> <span class="o">*</span> <span class="n">torch</span><span class="o">.</span><span class="n">eye</span><span class="p">(</span><span class="n">X</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>

        <span class="c1"># Compute K&#39;s inverse and Cholesky factorization</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_L</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">cholesky</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_K</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_K_inv</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_K</span><span class="o">.</span><span class="n">inverse</span><span class="p">()</span>
    
    <span class="k">def</span> <span class="nf">set_data</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">X</span><span class="p">,</span> <span class="n">Y</span><span class="p">,</span> <span class="n">normalize_y</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">reg</span><span class="o">=</span><span class="mf">1e-5</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Set the training data.</span>

<span class="sd">        Args:</span>
<span class="sd">            X (Tensor): Training inputs</span>
<span class="sd">            Y (Tensor): Training outputs</span>
<span class="sd">            normalize_y (Boolean): Normalize the outputs</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_non_normalized_Y</span> <span class="o">=</span> <span class="n">Y</span>

        <span class="k">if</span> <span class="n">normalize_y</span><span class="p">:</span>
            <span class="n">Y_mean</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">Y</span><span class="p">,</span> <span class="n">dim</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
            <span class="n">Y_std</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">std</span><span class="p">(</span><span class="n">Y</span><span class="p">,</span> <span class="n">dim</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
            <span class="n">Y</span> <span class="o">=</span> <span class="p">(</span><span class="n">Y</span> <span class="o">-</span> <span class="n">Y_mean</span><span class="p">)</span> <span class="o">/</span> <span class="n">Y_std</span>
        
        <span class="bp">self</span><span class="o">.</span><span class="n">_X</span> <span class="o">=</span> <span class="n">X</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_Y</span> <span class="o">=</span> <span class="n">Y</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_reg</span> <span class="o">=</span> <span class="n">reg</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_update_k</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_is_set</span> <span class="o">=</span> <span class="kc">True</span>
    
    <span class="k">def</span> <span class="nf">loss</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Negative marginal log-likelihood.&quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">_is_set</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">RuntimeError</span><span class="p">(</span><span class="s2">&quot;You must call set_data() first&quot;</span><span class="p">)</span>

        <span class="n">Y</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_Y</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_update_k</span><span class="p">()</span>
        <span class="n">K_inv</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_K_inv</span>

        <span class="c1"># Compute the log-likelihood</span>
        <span class="n">log_likelihood_dims</span> <span class="o">=</span> <span class="o">-</span><span class="mf">0.5</span> <span class="o">*</span> <span class="n">Y</span><span class="o">.</span><span class="n">t</span><span class="p">()</span><span class="o">.</span><span class="n">mm</span><span class="p">(</span><span class="n">K_inv</span><span class="o">.</span><span class="n">mm</span><span class="p">(</span><span class="n">Y</span><span class="p">))</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">dim</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
        <span class="n">log_likelihood_dims</span> <span class="o">-=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_L</span><span class="o">.</span><span class="n">diag</span><span class="p">()</span><span class="o">.</span><span class="n">log</span><span class="p">()</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span>
        <span class="n">log_likelihood_dims</span> <span class="o">-=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_L</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">/</span> <span class="mf">2.0</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="mi">2</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">pi</span><span class="p">)</span>
        <span class="n">log_likelihood</span> <span class="o">=</span> <span class="n">log_likelihood_dims</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">dim</span><span class="o">=-</span><span class="mi">1</span><span class="p">)</span>

        <span class="k">return</span> <span class="o">-</span><span class="n">log_likelihood</span>
    
    <span class="k">def</span> <span class="nf">forward</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span>
                <span class="n">x</span><span class="p">,</span>
                <span class="n">return_mean</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                <span class="n">return_var</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
                <span class="n">return_covar</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
                <span class="n">return_std</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
                <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Compute the GP estimate.</span>

<span class="sd">        Args:</span>
<span class="sd">            x (Tensor): Inputs</span>
<span class="sd">            return_mean (Boolean): Return the mean</span>
<span class="sd">            return_covar (Boolean): Return the full covariance matrix</span>
<span class="sd">            return_var (Boolean): Return the variance</span>
<span class="sd">            return_std (Boolean): Return the standard deviation</span>
<span class="sd">        </span>
<span class="sd">        Returns:</span>
<span class="sd">            Tensor or tuple of Tensors.</span>
<span class="sd">            The order of the tuple if all outputs are requested is:</span>
<span class="sd">                (mean, covariance, variance, standard deviation)</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">_is_set</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">RuntimeError</span><span class="p">(</span><span class="s2">&quot;You must call set_data() first&quot;</span><span class="p">)</span>
        
        <span class="n">X</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_X</span>
        <span class="n">Y</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_Y</span>
        <span class="n">K_inv</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_K_inv</span>

        <span class="c1"># Kernel functions</span>
        <span class="n">K_ss</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">kernel</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">x</span><span class="p">)</span>
        <span class="n">K_s</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">kernel</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">X</span><span class="p">)</span>

        <span class="c1"># Compute the mean</span>
        <span class="n">outputs</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">if</span> <span class="n">return_mean</span><span class="p">:</span>
            <span class="c1"># Non-normalized for scale</span>
            <span class="n">mean</span> <span class="o">=</span> <span class="n">K_s</span><span class="o">.</span><span class="n">mm</span><span class="p">(</span><span class="n">K_inv</span><span class="o">.</span><span class="n">mm</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_non_normalized_Y</span><span class="p">))</span>
            <span class="n">outputs</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">mean</span><span class="p">)</span>
        
        <span class="c1"># Compute covariance/variance/standard deviation</span>
        <span class="k">if</span> <span class="n">return_covar</span> <span class="ow">or</span> <span class="n">return_var</span> <span class="ow">or</span> <span class="n">return_std</span><span class="p">:</span>
            <span class="n">covar</span> <span class="o">=</span> <span class="n">K_ss</span> <span class="o">-</span> <span class="n">K_s</span><span class="o">.</span><span class="n">mm</span><span class="p">(</span><span class="n">K_inv</span><span class="o">.</span><span class="n">mm</span><span class="p">(</span><span class="n">K_s</span><span class="o">.</span><span class="n">t</span><span class="p">()))</span>
            <span class="k">if</span> <span class="n">return_covar</span><span class="p">:</span>
                <span class="n">outputs</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">covar</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">return_var</span> <span class="ow">or</span> <span class="n">return_std</span><span class="p">:</span>
                <span class="n">var</span> <span class="o">=</span> <span class="n">covar</span><span class="o">.</span><span class="n">diag</span><span class="p">()</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">return_var</span><span class="p">:</span>
                    <span class="n">outputs</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">var</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">return_std</span><span class="p">:</span>
                    <span class="n">std</span> <span class="o">=</span> <span class="n">var</span><span class="o">.</span><span class="n">sqrt</span><span class="p">()</span>
                    <span class="n">outputs</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">std</span><span class="p">)</span>
        
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">outputs</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">outputs</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        
        <span class="k">return</span> <span class="nb">tuple</span><span class="p">(</span><span class="n">outputs</span><span class="p">)</span>
    
    <span class="k">def</span> <span class="nf">fit</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">tol</span><span class="o">=</span><span class="mf">1e-6</span><span class="p">,</span> <span class="n">reg_factor</span><span class="o">=</span><span class="mf">10.0</span><span class="p">,</span> <span class="n">max_reg</span><span class="o">=</span><span class="mf">1.0</span><span class="p">,</span> <span class="n">max_iter</span><span class="o">=</span><span class="mi">1000</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Fits the model to the data.</span>

<span class="sd">        Args:</span>
<span class="sd">            tol (Float): Tolerance</span>
<span class="sd">            reg_factor (Float): Regularization multiplicative factor</span>
<span class="sd">            max_reg (Float): Maximum regularization term</span>
<span class="sd">            max_iter (Integer): Maximum number of iterations</span>
<span class="sd">        </span>
<span class="sd">        Returns:</span>
<span class="sd">            Number of iterations.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">_is_set</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">RuntimeError</span><span class="p">(</span><span class="s2">&quot;You must call set_data() first&quot;</span><span class="p">)</span>
            
        <span class="n">opt</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">optim</span><span class="o">.</span><span class="n">Adam</span><span class="p">(</span><span class="n">p</span> <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">parameters</span><span class="p">()</span> <span class="k">if</span> <span class="n">p</span><span class="o">.</span><span class="n">requires_grad</span><span class="p">)</span>

        <span class="k">while</span> <span class="bp">self</span><span class="o">.</span><span class="n">_reg</span> <span class="o">&lt;=</span> <span class="n">max_reg</span><span class="p">:</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">curr_loss</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">inf</span>
                <span class="n">n_iter</span> <span class="o">=</span> <span class="mi">0</span>

                <span class="k">while</span> <span class="n">n_iter</span> <span class="o">&lt;</span> <span class="n">max_iter</span><span class="p">:</span>
                    <span class="n">opt</span><span class="o">.</span><span class="n">zero_grad</span><span class="p">()</span>

                    <span class="n">prev_loss</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">loss</span><span class="p">()</span>
                    <span class="n">prev_loss</span><span class="o">.</span><span class="n">backward</span><span class="p">(</span><span class="n">retain_graph</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
                    <span class="n">opt</span><span class="o">.</span><span class="n">step</span><span class="p">()</span>

                    <span class="n">curr_loss</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">loss</span><span class="p">()</span>
                    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Step: </span><span class="si">{</span><span class="n">n_iter</span><span class="si">}</span><span class="s2">, Loss: </span><span class="si">{</span><span class="n">curr_loss</span><span class="o">.</span><span class="n">item</span><span class="p">()</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
                    <span class="n">dloss</span> <span class="o">=</span> <span class="n">curr_loss</span> <span class="o">-</span> <span class="n">prev_loss</span>
                    <span class="n">n_iter</span> <span class="o">+=</span> <span class="mi">1</span>
                    <span class="k">if</span> <span class="n">dloss</span><span class="o">.</span><span class="n">abs</span><span class="p">()</span> <span class="o">&lt;=</span> <span class="n">tol</span><span class="p">:</span>
                        <span class="k">break</span>
                
                <span class="k">return</span> <span class="n">n_iter</span>
            <span class="k">except</span> <span class="ne">RuntimeError</span><span class="p">:</span>
                <span class="c1"># Increase regularization term until it succeeds</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_reg</span> <span class="o">*=</span> <span class="n">reg_factor</span>
                <span class="k">continue</span>
</pre></div>
</div>
</div>
</div>
<p>For which we then need to define our kernel base class</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">class</span> <span class="nc">Kernel</span><span class="p">(</span><span class="n">nn</span><span class="o">.</span><span class="n">Module</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Base class for the kernel functions.&quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="fm">__add__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">other</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Sums two kernels together.and</span>
<span class="sd">        </span>
<span class="sd">        Args:</span>
<span class="sd">            other (Kernel): Other kernel.</span>
<span class="sd">        </span>
<span class="sd">        Returns:</span>
<span class="sd">            Aggregate Kernel</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="n">AggregateKernel</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">other</span><span class="p">,</span> <span class="n">torch</span><span class="o">.</span><span class="n">add</span><span class="p">)</span>
    
    <span class="k">def</span> <span class="fm">__mul__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">other</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Multiplies two kernel together.</span>

<span class="sd">        Args:</span>
<span class="sd">            other (Kernel): Other kernel</span>
<span class="sd">        </span>
<span class="sd">        Returns:</span>
<span class="sd">            Aggregate Kernel</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="n">AggregateKernel</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">other</span><span class="p">,</span> <span class="n">torch</span><span class="o">.</span><span class="n">mul</span><span class="p">)</span>
    
    <span class="k">def</span> <span class="fm">__sub__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">other</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Subtracts two kernels from each other.</span>

<span class="sd">        Args:</span>
<span class="sd">            other (Kernel): Other kernel</span>
<span class="sd">        </span>
<span class="sd">        Returns:</span>
<span class="sd">            Aggregate Kernel</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="n">AggregateKernel</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">other</span><span class="p">,</span> <span class="n">torch</span><span class="o">.</span><span class="n">sub</span><span class="p">)</span>
    
    <span class="k">def</span> <span class="nf">forward</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">xi</span><span class="p">,</span> <span class="n">xj</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Covariance function</span>

<span class="sd">        Args:</span>
<span class="sd">            xi (Tensor): First matrix</span>
<span class="sd">            xj (Tensor): Second matrix</span>
<span class="sd">        </span>
<span class="sd">        Returns:</span>
<span class="sd">            Covariance (Tensor)</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">raise</span> <span class="ne">NotImplementedError</span>


<span class="k">class</span> <span class="nc">AggregateKernel</span><span class="p">(</span><span class="n">Kernel</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;An aggregate kernel.&quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">first</span><span class="p">,</span> <span class="n">second</span><span class="p">,</span> <span class="n">op</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Constructs an Aggregate Kernel</span>

<span class="sd">        Args:</span>
<span class="sd">            first (Kernel): First kernel</span>
<span class="sd">            second (Kernel): Second kernel</span>
<span class="sd">            op (Function): Operation to apply</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="nb">super</span><span class="p">(</span><span class="n">Kernel</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="fm">__init__</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">first</span> <span class="o">=</span> <span class="n">first</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">second</span> <span class="o">=</span> <span class="n">second</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">op</span> <span class="o">=</span> <span class="n">op</span>
    
    <span class="k">def</span> <span class="nf">forward</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">xi</span><span class="p">,</span> <span class="n">xj</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Covariance function</span>

<span class="sd">        Args:</span>
<span class="sd">            xi (Tensor): First matrix</span>
<span class="sd">            xj (Tensor): Second matrix</span>
<span class="sd">        </span>
<span class="sd">        Returns:</span>
<span class="sd">            Covariance (Tensor)</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">first</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">first</span><span class="p">(</span><span class="n">xi</span><span class="p">,</span> <span class="n">xj</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
        <span class="n">second</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">second</span><span class="p">(</span><span class="n">xi</span><span class="p">,</span> <span class="n">xj</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">op</span><span class="p">(</span><span class="n">first</span><span class="p">,</span> <span class="n">second</span><span class="p">)</span>

<span class="k">def</span> <span class="nf">mahalanobis_squared</span><span class="p">(</span><span class="n">xi</span><span class="p">,</span> <span class="n">xj</span><span class="p">,</span> <span class="n">VI</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Computes the pair-wise squared mahalanobis distance matrix.</span>

<span class="sd">    Args:</span>
<span class="sd">        xi (Tensor): xi input matrix</span>
<span class="sd">        xj (Tensor): xj input matrix</span>
<span class="sd">        VI (Tensor): The inverse of the covariance matrix, by default the</span>
<span class="sd">            identity matrix</span>
<span class="sd">    </span>
<span class="sd">    Returns:</span>
<span class="sd">        Weighted matrix of all pair-wise distances (Tensor)</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="n">VI</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">xi_VI</span> <span class="o">=</span> <span class="n">xi</span>
        <span class="n">xj_VI</span> <span class="o">=</span> <span class="n">xj</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">xi_VI</span> <span class="o">=</span> <span class="n">xi</span><span class="o">.</span><span class="n">mm</span><span class="p">(</span><span class="n">VI</span><span class="p">)</span>
        <span class="n">xj_VI</span> <span class="o">=</span> <span class="n">xj</span><span class="o">.</span><span class="n">mm</span><span class="p">(</span><span class="n">VI</span><span class="p">)</span>
    
    <span class="n">D_squared</span> <span class="o">=</span> <span class="p">(</span><span class="n">xi_VI</span> <span class="o">*</span> <span class="n">xi</span><span class="p">)</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">dim</span><span class="o">=-</span><span class="mi">1</span><span class="p">)</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span> \
                <span class="o">+</span> <span class="p">(</span><span class="n">xj_VI</span> <span class="o">*</span> <span class="n">xj</span><span class="p">)</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">dim</span><span class="o">=-</span><span class="mi">1</span><span class="p">)</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span> \
                <span class="o">-</span> <span class="mi">2</span> <span class="o">*</span> <span class="n">xi_VI</span><span class="o">.</span><span class="n">mm</span><span class="p">(</span><span class="n">xj</span><span class="o">.</span><span class="n">t</span><span class="p">())</span>
    
    <span class="k">return</span> <span class="n">D_squared</span>
</pre></div>
</div>
</div>
</div>
<p>With which we can then define the RBF Kernel, and the White Noise Kernel</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">class</span> <span class="nc">RBFKernel</span><span class="p">(</span><span class="n">Kernel</span><span class="p">):</span>

<span class="w">    </span><span class="sd">&quot;&quot;&quot;Radial-basis function kernel.&quot;&quot;&quot;</span>
    
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">length_scale</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">sigma_s</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">eps</span><span class="o">=</span><span class="mf">1e-6</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Constructs an RBF Kernel</span>

<span class="sd">        Args:</span>
<span class="sd">            length_scale (Tensor): Length scale</span>
<span class="sd">            sigma_s (Tensor): Signal standard deviation</span>
<span class="sd">            eps (Float): Minimum bound for parameters</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="nb">super</span><span class="p">(</span><span class="n">Kernel</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="fm">__init__</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">length_scale</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">nn</span><span class="o">.</span><span class="n">Parameter</span><span class="p">(</span>
            <span class="n">torch</span><span class="o">.</span><span class="n">randn</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span> <span class="k">if</span> <span class="n">length_scale</span> <span class="ow">is</span> <span class="kc">None</span> <span class="k">else</span> <span class="n">length_scale</span>
        <span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">sigma_s</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">nn</span><span class="o">.</span><span class="n">Parameter</span><span class="p">(</span>
            <span class="n">torch</span><span class="o">.</span><span class="n">randn</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span> <span class="k">if</span> <span class="n">sigma_s</span> <span class="ow">is</span> <span class="kc">None</span> <span class="k">else</span> <span class="n">sigma_s</span>
        <span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_eps</span> <span class="o">=</span> <span class="n">eps</span>
    
    <span class="k">def</span> <span class="nf">forward</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">xi</span><span class="p">,</span> <span class="n">xj</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Covariance function</span>

<span class="sd">        Args:</span>
<span class="sd">            xi (Tensor): First matrix</span>
<span class="sd">            xj (Tensor): Second matrix</span>
<span class="sd">        </span>
<span class="sd">        Returns:</span>
<span class="sd">            Covariance (Tensor)</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">length_scale</span> <span class="o">=</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">length_scale</span><span class="o">**-</span><span class="mi">2</span><span class="p">)</span><span class="o">.</span><span class="n">clamp</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_eps</span><span class="p">,</span> <span class="mf">1e5</span><span class="p">)</span>
        <span class="n">var_s</span> <span class="o">=</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">sigma_s</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span><span class="o">.</span><span class="n">clamp</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_eps</span><span class="p">,</span> <span class="mf">1e5</span><span class="p">)</span>

        <span class="n">M</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">eye</span><span class="p">(</span><span class="n">xi</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span> <span class="o">*</span> <span class="n">length_scale</span>
        <span class="n">dist</span> <span class="o">=</span> <span class="n">mahalanobis_squared</span><span class="p">(</span><span class="n">xi</span><span class="p">,</span> <span class="n">xj</span><span class="p">,</span> <span class="n">M</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">var_s</span> <span class="o">*</span> <span class="p">(</span><span class="o">-</span><span class="mf">0.5</span> <span class="o">*</span> <span class="n">dist</span><span class="p">)</span><span class="o">.</span><span class="n">exp</span><span class="p">()</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">class</span> <span class="nc">WhiteNoiseKernel</span><span class="p">(</span><span class="n">Kernel</span><span class="p">):</span>

<span class="w">    </span><span class="sd">&quot;&quot;&quot;White noise kernel.&quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">sigma_n</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">eps</span><span class="o">=</span><span class="mf">1e-6</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Instantiates a white noise kernel</span>

<span class="sd">        Args:</span>
<span class="sd">            sigma_n (Tensor): Noise standard deviation</span>
<span class="sd">            eps (Float): Minimum bound for parameters</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="nb">super</span><span class="p">(</span><span class="n">Kernel</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="fm">__init__</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">sigma_n</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">nn</span><span class="o">.</span><span class="n">Parameter</span><span class="p">(</span>
            <span class="n">torch</span><span class="o">.</span><span class="n">randn</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span> <span class="k">if</span> <span class="n">sigma_n</span> <span class="ow">is</span> <span class="kc">None</span> <span class="k">else</span> <span class="n">sigma_n</span>
        <span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_eps</span> <span class="o">=</span> <span class="n">eps</span>
    
    <span class="k">def</span> <span class="nf">forward</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">xi</span><span class="p">,</span> <span class="n">xj</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Covariance function</span>

<span class="sd">        Args:</span>
<span class="sd">            xi (Tensor): First matrix</span>
<span class="sd">            xj (Tensor): Second matrix</span>
<span class="sd">        </span>
<span class="sd">        Returns:</span>
<span class="sd">            Covariance (Tensor)</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">var_n</span> <span class="o">=</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">sigma_n</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span><span class="o">.</span><span class="n">clamp</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_eps</span><span class="p">,</span> <span class="mf">1e5</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">var_n</span>
</pre></div>
</div>
</div>
</div>
<p>We can now set up the training and test data to test this handwritten implementation</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">torch</span><span class="o">.</span><span class="n">manual_seed</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
<span class="n">X</span> <span class="o">=</span> <span class="mi">10</span> <span class="o">*</span> <span class="n">torch</span><span class="o">.</span><span class="n">rand</span><span class="p">(</span><span class="mi">50</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span> <span class="o">-</span> <span class="mi">4</span>
<span class="n">X_train</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">tensor</span><span class="p">(</span><span class="nb">sorted</span><span class="p">(</span><span class="n">torch</span><span class="o">.</span><span class="n">cat</span><span class="p">([</span><span class="n">X</span><span class="p">]</span> <span class="o">*</span> <span class="mi">4</span><span class="p">)))</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">math</span>
<span class="n">torch</span><span class="o">.</span><span class="n">manual_seed</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>

<span class="k">def</span> <span class="nf">real_data_distribution</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">noise_var</span><span class="o">=</span><span class="mf">0.0</span><span class="p">):</span>
    <span class="k">return</span> <span class="n">torch</span><span class="o">.</span><span class="n">sin</span><span class="p">(</span><span class="n">x</span><span class="o">*</span><span class="n">math</span><span class="o">.</span><span class="n">pi</span><span class="p">)</span> <span class="o">+</span> <span class="n">math</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">noise_var</span><span class="p">)</span> <span class="o">*</span> <span class="n">torch</span><span class="o">.</span><span class="n">randn</span><span class="p">(</span><span class="n">x</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span>

<span class="n">Y_train</span> <span class="o">=</span> <span class="n">real_data_distribution</span><span class="p">(</span><span class="n">X_train</span><span class="p">,</span> <span class="n">noise_var</span><span class="o">=</span><span class="mf">0.04</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="nb">print</span><span class="p">(</span><span class="n">X_train</span><span class="o">.</span><span class="n">shape</span><span class="p">,</span> <span class="n">Y_train</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">scatter</span><span class="p">(</span><span class="n">X_train</span><span class="p">,</span> <span class="n">Y_train</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">grid</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>torch.Size([200, 1]) torch.Size([200, 1])
</pre></div>
</div>
<img alt="../_images/4939435872ebadc30e88608184a09a560fa612a0669d12fc326712fed8338042.png" src="../_images/4939435872ebadc30e88608184a09a560fa612a0669d12fc326712fed8338042.png" />
</div>
</div>
<p>With which we can now train the handwritten Gaussian Process implementation</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">time</span>

<span class="n">k</span> <span class="o">=</span> <span class="n">RBFKernel</span><span class="p">()</span> <span class="o">+</span> <span class="n">WhiteNoiseKernel</span><span class="p">()</span>  <span class="c1"># equiv: RBFKernel().__add__(WhiteNoiseKernel())</span>
<span class="n">gp</span> <span class="o">=</span> <span class="n">GaussianProcess</span><span class="p">(</span><span class="n">k</span><span class="p">)</span>
<span class="n">gp</span><span class="o">.</span><span class="n">set_data</span><span class="p">(</span><span class="n">X_train</span><span class="p">,</span> <span class="n">Y_train</span><span class="p">)</span>
<span class="n">start</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>
<span class="n">gp</span><span class="o">.</span><span class="n">fit</span><span class="p">()</span>
<span class="n">end</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;The GP took </span><span class="si">{}</span><span class="s2"> seconds to train.&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">end</span> <span class="o">-</span> <span class="n">start</span><span class="p">))</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Step: 0, Loss: 356.762506001995
Step: 1, Loss: 356.66593124753877
Step: 2, Loss: 356.5691845987471
Step: 3, Loss: 356.47226355735705
Step: 4, Loss: 356.37516563996815
Step: 5, Loss: 356.2778883857675
Step: 6, Loss: 356.18042936409324
Step: 7, Loss: 356.0827861817892
Step: 8, Loss: 355.9849564903037
Step: 9, Loss: 355.88693799249336
Step: 10, Loss: 355.7887284490921
Step: 11, Loss: 355.6903256848161
Step: 12, Loss: 355.59172759407625
Step: 13, Loss: 355.4929321462763
Step: 14, Loss: 355.3939373906808
Step: 15, Loss: 355.2947414608411
Step: 16, Loss: 355.1953425785747
Step: 17, Loss: 355.09573905749284
Step: 18, Loss: 354.99592930608435
Step: 19, Loss: 354.89591183035907
Step: 20, Loss: 354.79568523606383
Step: 21, Loss: 354.69524823048414
Step: 22, Loss: 354.5945996238504
Step: 23, Loss: 354.4937383303655
Step: 24, Loss: 354.3926633688774
Step: 25, Loss: 354.29137386321855
Step: 26, Loss: 354.18986904223607
Step: 27, Loss: 354.0881482395364
Step: 28, Loss: 353.98621089297103
Step: 29, Loss: 353.884056543885
Step: 30, Loss: 353.7816848361551
Step: 31, Loss: 353.6790955150391
Step: 32, Loss: 353.57628842586007
Step: 33, Loss: 353.4732635125464
Step: 34, Loss: 353.3700208160485
Step: 35, Loss: 353.2665604726511
Step: 36, Loss: 353.16288271219844
Step: 37, Loss: 353.0589878562495
Step: 38, Loss: 352.9548763161772
Step: 39, Loss: 352.85054859122647
Step: 40, Loss: 352.7460052665405
Step: 41, Loss: 352.6412470111703
Step: 42, Loss: 352.5362745760716
Step: 43, Loss: 352.43108879210274
Step: 44, Loss: 352.3256905680257
Step: 45, Loss: 352.2200808885201
Step: 46, Loss: 352.1142608122127
Step: 47, Loss: 352.008231469727
Step: 48, Loss: 351.90199406175736
Step: 49, Loss: 351.7955498571682
Step: 50, Loss: 351.68890019112143
Step: 51, Loss: 351.5820464632325
Step: 52, Loss: 351.4749901357567
Step: 53, Loss: 351.3677327318047
Step: 54, Loss: 351.26027583358865
Step: 55, Loss: 351.1526210806963
Step: 56, Loss: 351.04477016839473
Step: 57, Loss: 350.93672484596175
Step: 58, Loss: 350.8284869150423
Step: 59, Loss: 350.7200582280316
Step: 60, Loss: 350.61144068648105
Step: 61, Loss: 350.50263623952696
Step: 62, Loss: 350.39364688234025
Step: 63, Loss: 350.2844746545947
Step: 64, Loss: 350.17512163895435
Step: 65, Loss: 350.06558995957664
Step: 66, Loss: 349.9558817806311
Step: 67, Loss: 349.8459993048317
Step: 68, Loss: 349.7359447719814
Step: 69, Loss: 349.6257204575294
Step: 70, Loss: 349.5153286711369
Step: 71, Loss: 349.40477175525405
Step: 72, Loss: 349.29405208370395
Step: 73, Loss: 349.18317206027507
Step: 74, Loss: 349.07213411732045
Step: 75, Loss: 348.960940714363
Step: 76, Loss: 348.8495943367072
Step: 77, Loss: 348.7380974940552
Step: 78, Loss: 348.62645271912925
Step: 79, Loss: 348.5146625662983
Step: 80, Loss: 348.402729610209
Step: 81, Loss: 348.2906564444222
Step: 82, Loss: 348.1784456800533
Step: 83, Loss: 348.0660999444175
Step: 84, Loss: 347.95362187968055
Step: 85, Loss: 347.8410141415136
Step: 86, Loss: 347.72827939775436
Step: 87, Loss: 347.6154203270734
Step: 88, Loss: 347.50243961764653
Step: 89, Loss: 347.3893399658343
Step: 90, Loss: 347.276124074868
Step: 91, Loss: 347.1627946535434
Step: 92, Loss: 347.0493544149228
Step: 93, Loss: 346.9358060750452
Step: 94, Loss: 346.8221523516466
Step: 95, Loss: 346.7083959628898
Step: 96, Loss: 346.5945396261051
Step: 97, Loss: 346.48058605654137
Step: 98, Loss: 346.36653796613086
Step: 99, Loss: 346.2523980622652
Step: 100, Loss: 346.1381690465855
Step: 101, Loss: 346.0238536137864
Step: 102, Loss: 345.90945445043474
Step: 103, Loss: 345.79497423380434
Step: 104, Loss: 345.6804156307265
Step: 105, Loss: 345.56578129645754
Step: 106, Loss: 345.45107387356387
Step: 107, Loss: 345.3362959908259
Step: 108, Loss: 345.22145026216
Step: 109, Loss: 345.10653928556064
Step: 110, Loss: 344.99156564206294
Step: 111, Loss: 344.876531894725
Step: 112, Loss: 344.761440587633
Step: 113, Loss: 344.64629424492676
Step: 114, Loss: 344.5310953698495
Step: 115, Loss: 344.41584644381896
Step: 116, Loss: 344.30054992552283
Step: 117, Loss: 344.185208250038
Step: 118, Loss: 344.0698238279743
Step: 119, Loss: 343.95439904464234
Step: 120, Loss: 343.8389362592476
Step: 121, Loss: 343.72343780410876
Step: 122, Loss: 343.6079059839027
Step: 123, Loss: 343.49234307493487
Step: 124, Loss: 343.3767513244368
Step: 125, Loss: 343.26113294988915
Step: 126, Loss: 343.145490138372
Step: 127, Loss: 343.02982504594195
Step: 128, Loss: 342.91413979703634
Step: 129, Loss: 342.79843648390363
Step: 130, Loss: 342.68271716606233
Step: 131, Loss: 342.5669838697858
Step: 132, Loss: 342.4512385876148
Step: 133, Loss: 342.33548327789686
Step: 134, Loss: 342.2197198643534
Step: 135, Loss: 342.1039502356724
Step: 136, Loss: 341.9881762451296
Step: 137, Loss: 341.87239971023484
Step: 138, Loss: 341.75662241240616
Step: 139, Loss: 341.6408460966695
Step: 140, Loss: 341.52507247138465
Step: 141, Loss: 341.409303207997
Step: 142, Loss: 341.2935399408151
Step: 143, Loss: 341.17778426681343
Step: 144, Loss: 341.06203774545986
Step: 145, Loss: 340.94630189856827
Step: 146, Loss: 340.83057821017474
Step: 147, Loss: 340.71486812643843
Step: 148, Loss: 340.5991730555655
Step: 149, Loss: 340.48349436775584
Step: 150, Loss: 340.36783339517353
Step: 151, Loss: 340.2521914319383
Step: 152, Loss: 340.1365697341398
Step: 153, Loss: 340.0209695198722
Step: 154, Loss: 339.9053919692907
Step: 155, Loss: 339.7898382246875
Step: 156, Loss: 339.67430939058795
Step: 157, Loss: 339.5588065338663
Step: 158, Loss: 339.4433306838797
Step: 159, Loss: 339.32788283262096
Step: 160, Loss: 339.2124639348889
Step: 161, Loss: 339.09707490847586
Step: 162, Loss: 338.981716634372
Step: 163, Loss: 338.8663899569858
Step: 164, Loss: 338.7510956843798
Step: 165, Loss: 338.6358345885219
Step: 166, Loss: 338.5206074055508
Step: 167, Loss: 338.40541483605546
Step: 168, Loss: 338.2902575453678
Step: 169, Loss: 338.17513616386884
Step: 170, Loss: 338.06005128730624
Step: 171, Loss: 337.94500347712426
Step: 172, Loss: 337.82999326080494
Step: 173, Loss: 337.71502113221936
Step: 174, Loss: 337.6000875519896
Step: 175, Loss: 337.4851929478604
Step: 176, Loss: 337.37033771507936
Step: 177, Loss: 337.25552221678606
Step: 178, Loss: 337.14074678440943
Step: 179, Loss: 337.02601171807237
Step: 180, Loss: 336.9113172870034
Step: 181, Loss: 336.79666372995547
Step: 182, Loss: 336.68205125563003
Step: 183, Loss: 336.5674800431076
Step: 184, Loss: 336.4529502422828
Step: 185, Loss: 336.33846197430466
Step: 186, Loss: 336.2240153320208
Step: 187, Loss: 336.10961038042603
Step: 188, Loss: 335.99524715711345
Step: 189, Loss: 335.8809256727296
Step: 190, Loss: 335.7666459114316
Step: 191, Loss: 335.65240783134686
Step: 192, Loss: 335.5382113650343
Step: 193, Loss: 335.42405641994725
Step: 194, Loss: 335.3099428788978
Step: 195, Loss: 335.1958706005212
Step: 196, Loss: 335.08183941974085
Step: 197, Loss: 334.9678491482347
Step: 198, Loss: 334.85389957489906
Step: 199, Loss: 334.73999046631434
Step: 200, Loss: 334.62612156720814
Step: 201, Loss: 334.5122926009182
Step: 202, Loss: 334.398503269854
Step: 203, Loss: 334.28475325595605
Step: 204, Loss: 334.17104222115427
Step: 205, Loss: 334.0573698078232
Step: 206, Loss: 333.943735639236
Step: 207, Loss: 333.8301393200147
Step: 208, Loss: 333.71658043657897
Step: 209, Loss: 333.60305855759003
Step: 210, Loss: 333.4895732343939
Step: 211, Loss: 333.37612400145923
Step: 212, Loss: 333.26271037681204
Step: 213, Loss: 333.14933186246776
Step: 214, Loss: 333.0359879448581
Step: 215, Loss: 332.9226780952551
Step: 216, Loss: 332.8094017701898
Step: 217, Loss: 332.696158411868
Step: 218, Loss: 332.58294744858046
Step: 219, Loss: 332.4697682951095
Step: 220, Loss: 332.3566203531305
Step: 221, Loss: 332.2435030116087
Step: 222, Loss: 332.1304156471918
Step: 223, Loss: 332.0173576245968
Step: 224, Loss: 331.9043282969924
Step: 225, Loss: 331.79132700637683
Step: 226, Loss: 331.6783530839498
Step: 227, Loss: 331.56540585047946
Step: 228, Loss: 331.45248461666506
Step: 229, Loss: 331.33958868349293
Step: 230, Loss: 331.2267173425888
Step: 231, Loss: 331.1138698765636
Step: 232, Loss: 331.00104555935434
Step: 233, Loss: 330.8882436565601
Step: 234, Loss: 330.77546342577216
Step: 235, Loss: 330.66270411689857
Step: 236, Loss: 330.5499649724843
Step: 237, Loss: 330.43724522802495
Step: 238, Loss: 330.3245441122756
Step: 239, Loss: 330.2118608475545
Step: 240, Loss: 330.0991946500411
Step: 241, Loss: 329.9865447300685
Step: 242, Loss: 329.8739102924113
Step: 243, Loss: 329.76129053656757
Step: 244, Loss: 329.64868465703546
Step: 245, Loss: 329.5360918435849
Step: 246, Loss: 329.4235112815246
Step: 247, Loss: 329.31094215196197
Step: 248, Loss: 329.1983836320601
Step: 249, Loss: 329.08583489528826
Step: 250, Loss: 328.9732951116679
Step: 251, Loss: 328.8607634480129
Step: 252, Loss: 328.74823906816596
Step: 253, Loss: 328.63572113322874
Step: 254, Loss: 328.5232088017881
Step: 255, Loss: 328.41070123013685
Step: 256, Loss: 328.29819757249004
Step: 257, Loss: 328.1856969811962
Step: 258, Loss: 328.07319860694423
Step: 259, Loss: 327.960701598965
Step: 260, Loss: 327.8482051052291
Step: 261, Loss: 327.73570827263933
Step: 262, Loss: 327.6232102472193
Step: 263, Loss: 327.51071017429683
Step: 264, Loss: 327.398207198684
Step: 265, Loss: 327.28570046485186
Step: 266, Loss: 327.17318911710106
Step: 267, Loss: 327.0606722997291
Step: 268, Loss: 326.9481491571921
Step: 269, Loss: 326.83561883426364
Step: 270, Loss: 326.7230804761887
Step: 271, Loss: 326.6105332288341
Step: 272, Loss: 326.4979762388346
Step: 273, Loss: 326.38540865373614
Step: 274, Loss: 326.2728296221335
Step: 275, Loss: 326.16023829380583
Step: 276, Loss: 326.0476338198479
Step: 277, Loss: 325.9350153527972
Step: 278, Loss: 325.82238204675855
Step: 279, Loss: 325.7097330575241
Step: 280, Loss: 325.59706754269047
Step: 281, Loss: 325.48438466177254
Step: 282, Loss: 325.37168357631333
Step: 283, Loss: 325.2589634499913
Step: 284, Loss: 325.14622344872396
Step: 285, Loss: 325.0334627407681
Step: 286, Loss: 324.9206804968177
Step: 287, Loss: 324.80787589009776
Step: 288, Loss: 324.69504809645605
Step: 289, Loss: 324.58219629445114
Step: 290, Loss: 324.46931966543775
Step: 291, Loss: 324.35641739364956
Step: 292, Loss: 324.24348866627895
Step: 293, Loss: 324.1305326735537
Step: 294, Loss: 324.0175486088117
Step: 295, Loss: 323.90453566857195
Step: 296, Loss: 323.7914930526041
Step: 297, Loss: 323.67841996399505
Step: 298, Loss: 323.5653156092121
Step: 299, Loss: 323.45217919816525
Step: 300, Loss: 323.3390099442656
Step: 301, Loss: 323.22580706448264
Step: 302, Loss: 323.112569779398
Step: 303, Loss: 322.9992973132581
Step: 304, Loss: 322.8859888940235
Step: 305, Loss: 322.7726437534168
Step: 306, Loss: 322.6592611269681
Step: 307, Loss: 322.54584025405813
Step: 308, Loss: 322.43238037796004
Step: 309, Loss: 322.31888074587835
Step: 310, Loss: 322.2053406089862
Step: 311, Loss: 322.0917592224609
Step: 312, Loss: 321.9781358455172
Step: 313, Loss: 321.86446974143905
Step: 314, Loss: 321.7507601776092
Step: 315, Loss: 321.6370064255371
Step: 316, Loss: 321.52320776088527
Step: 317, Loss: 321.4093634634936
Step: 318, Loss: 321.2954728174021
Step: 319, Loss: 321.18153511087246
Step: 320, Loss: 321.06754963640685
Step: 321, Loss: 320.95351569076644
Step: 322, Loss: 320.83943257498754
Step: 323, Loss: 320.72529959439635
Step: 324, Loss: 320.6111160586226
Step: 325, Loss: 320.49688128161137
Step: 326, Loss: 320.38259458163344
Step: 327, Loss: 320.2682552812948
Step: 328, Loss: 320.1538627075437
Step: 329, Loss: 320.0394161916778
Step: 330, Loss: 319.9249150693488
Step: 331, Loss: 319.81035868056665
Step: 332, Loss: 319.6957463697016
Step: 333, Loss: 319.58107748548645
Step: 334, Loss: 319.46635138101556
Step: 335, Loss: 319.35156741374476
Step: 336, Loss: 319.2367249454891
Step: 337, Loss: 319.12182334241913
Step: 338, Loss: 319.0068619750574
Step: 339, Loss: 318.8918402182722
Step: 340, Loss: 318.7767574512717
Step: 341, Loss: 318.66161305759624
Step: 342, Loss: 318.5464064251103
Step: 343, Loss: 318.43113694599253
Step: 344, Loss: 318.3158040167259
Step: 345, Loss: 318.2004070380865
Step: 346, Loss: 318.0849454151308
Step: 347, Loss: 317.9694185571833
Step: 348, Loss: 317.8538258778225
Step: 349, Loss: 317.7381667948659
Step: 350, Loss: 317.62244073035475
Step: 351, Loss: 317.5066471105379
Step: 352, Loss: 317.39078536585464
Step: 353, Loss: 317.2748549309165
Step: 354, Loss: 317.15885524448936
Step: 355, Loss: 317.04278574947375
Step: 356, Loss: 316.92664589288535
Step: 357, Loss: 316.8104351258338
Step: 358, Loss: 316.6941529035022
Step: 359, Loss: 316.57779868512455
Step: 360, Loss: 316.4613719339638
Step: 361, Loss: 316.34487211728833
Step: 362, Loss: 316.22829870634894
Step: 363, Loss: 316.11165117635363
Step: 364, Loss: 315.99492900644407
Step: 365, Loss: 315.87813167966925
Step: 366, Loss: 315.7612586829605
Step: 367, Loss: 315.64430950710465
Step: 368, Loss: 315.5272836467177
Step: 369, Loss: 315.41018060021725
Step: 370, Loss: 315.2929998697953
Step: 371, Loss: 315.17574096138986
Step: 372, Loss: 315.0584033846564
Step: 373, Loss: 314.9409866529394
Step: 374, Loss: 314.8234902832425
Step: 375, Loss: 314.7059137961995
Step: 376, Loss: 314.5882567160442
Step: 377, Loss: 314.4705185705796
Step: 378, Loss: 314.352698891148
Step: 379, Loss: 314.2347972125997
Step: 380, Loss: 314.11681307326177
Step: 381, Loss: 313.9987460149067
Step: 382, Loss: 313.8805955827206
Step: 383, Loss: 313.76236132527083
Step: 384, Loss: 313.6440427944745
Step: 385, Loss: 313.525639545565
Step: 386, Loss: 313.4071511370602
Step: 387, Loss: 313.288577130729
Step: 388, Loss: 313.1699170915583
Step: 389, Loss: 313.05117058772
Step: 390, Loss: 312.9323371905373
Step: 391, Loss: 312.8134164744512
Step: 392, Loss: 312.6944080169867
Step: 393, Loss: 312.5753113987192
Step: 394, Loss: 312.4561262032399
Step: 395, Loss: 312.3368520171226
Step: 396, Loss: 312.2174884298888
Step: 397, Loss: 312.0980350339737
Step: 398, Loss: 311.9784914246916
Step: 399, Loss: 311.8588572002021
Step: 400, Loss: 311.739131961475
Step: 401, Loss: 311.6193153122558
Step: 402, Loss: 311.4994068590317
Step: 403, Loss: 311.3794062109964
Step: 404, Loss: 311.2593129800159
Step: 405, Loss: 311.13912678059387
Step: 406, Loss: 311.0188472298364
Step: 407, Loss: 310.89847394741855
Step: 408, Loss: 310.7780065555488
Step: 409, Loss: 310.6574446789349
Step: 410, Loss: 310.53678794474934
Step: 411, Loss: 310.4160359825948
Step: 412, Loss: 310.2951884244697
Step: 413, Loss: 310.1742449047341
Step: 414, Loss: 310.053205060075
Step: 415, Loss: 309.9320685294724
Step: 416, Loss: 309.8108349541651
Step: 417, Loss: 309.6895039776167
Step: 418, Loss: 309.5680752454814
Step: 419, Loss: 309.4465484055705
Step: 420, Loss: 309.32492310781845
Step: 421, Loss: 309.20319900424926
Step: 422, Loss: 309.08137574894306
Step: 423, Loss: 308.9594529980025
Step: 424, Loss: 308.83743040951987
Step: 425, Loss: 308.7153076435437
Step: 426, Loss: 308.59308436204606
Step: 427, Loss: 308.4707602288894
Step: 428, Loss: 308.34833490979435
Step: 429, Loss: 308.22580807230685
Step: 430, Loss: 308.103179385766
Step: 431, Loss: 307.98044852127197
Step: 432, Loss: 307.85761515165393
Step: 433, Loss: 307.73467895143847
Step: 434, Loss: 307.6116395968174
Step: 435, Loss: 307.48849676561724
Step: 436, Loss: 307.36525013726725
Step: 437, Loss: 307.2418993927688
Step: 438, Loss: 307.1184442146644
Step: 439, Loss: 306.9948842870071
Step: 440, Loss: 306.8712192953302
Step: 441, Loss: 306.7474489266168
Step: 442, Loss: 306.6235728692702
Step: 443, Loss: 306.49959081308396
Step: 444, Loss: 306.37550244921187
Step: 445, Loss: 306.25130747013964
Step: 446, Loss: 306.127005569655
Step: 447, Loss: 306.0025964428192
Step: 448, Loss: 305.8780797859382
Step: 449, Loss: 305.7534552965345
Step: 450, Loss: 305.6287226733188
Step: 451, Loss: 305.50388161616195
Step: 452, Loss: 305.37893182606786
Step: 453, Loss: 305.2538730051453
Step: 454, Loss: 305.1287048565812
Step: 455, Loss: 305.00342708461346
Step: 456, Loss: 304.8780393945046
Step: 457, Loss: 304.75254149251475
Step: 458, Loss: 304.6269330858759
Step: 459, Loss: 304.50121388276585
Step: 460, Loss: 304.3753835922823
Step: 461, Loss: 304.2494419244175
Step: 462, Loss: 304.1233885900333
Step: 463, Loss: 303.9972233008357
Step: 464, Loss: 303.8709457693506
Step: 465, Loss: 303.7445557088991
Step: 466, Loss: 303.61805283357336
Step: 467, Loss: 303.49143685821275
Step: 468, Loss: 303.36470749837997
Step: 469, Loss: 303.2378644703379
Step: 470, Loss: 303.1109074910262
Step: 471, Loss: 302.9838362780383
Step: 472, Loss: 302.8566505495992
Step: 473, Loss: 302.72935002454227
Step: 474, Loss: 302.6019344222881
Step: 475, Loss: 302.47440346282144
Step: 476, Loss: 302.3467568666706
Step: 477, Loss: 302.2189943548852
Step: 478, Loss: 302.0911156490156
Step: 479, Loss: 301.96312047109166
Step: 480, Loss: 301.83500854360216
Step: 481, Loss: 301.7067795894744
Step: 482, Loss: 301.57843333205403
Step: 483, Loss: 301.44996949508493
Step: 484, Loss: 301.32138780268986
Step: 485, Loss: 301.1926879793509
Step: 486, Loss: 301.06386974989016
Step: 487, Loss: 300.93493283945065
Step: 488, Loss: 300.80587697347784
Step: 489, Loss: 300.67670187770136
Step: 490, Loss: 300.5474072781161
Step: 491, Loss: 300.4179929009648
Step: 492, Loss: 300.2884584727199
Step: 493, Loss: 300.1588037200663
Step: 494, Loss: 300.0290283698836
Step: 495, Loss: 299.8991321492293
Step: 496, Loss: 299.7691147853219
Step: 497, Loss: 299.63897600552434
Step: 498, Loss: 299.50871553732713
Step: 499, Loss: 299.37833310833275
Step: 500, Loss: 299.24782844623894
Step: 501, Loss: 299.1172012788237
Step: 502, Loss: 298.98645133392915
Step: 503, Loss: 298.85557833944637
Step: 504, Loss: 298.72458202330023
Step: 505, Loss: 298.59346211343455
Step: 506, Loss: 298.46221833779697
Step: 507, Loss: 298.33085042432504
Step: 508, Loss: 298.19935810093136
Step: 509, Loss: 298.0677410954896
Step: 510, Loss: 297.9359991358208
Step: 511, Loss: 297.8041319496791
Step: 512, Loss: 297.6721392647388
Step: 513, Loss: 297.5400208085804
Step: 514, Loss: 297.40777630867785
Step: 515, Loss: 297.27540549238535
Step: 516, Loss: 297.14290808692454
Step: 517, Loss: 297.01028381937215
Step: 518, Loss: 296.8775324166469
Step: 519, Loss: 296.74465360549783
Step: 520, Loss: 296.6116471124921
Step: 521, Loss: 296.47851266400266
Step: 522, Loss: 296.34524998619673
Step: 523, Loss: 296.21185880502446
Step: 524, Loss: 296.078338846207
Step: 525, Loss: 295.94468983522535
Step: 526, Loss: 295.8109114973097
Step: 527, Loss: 295.6770035574277
Step: 528, Loss: 295.5429657402742
Step: 529, Loss: 295.4087977702603
Step: 530, Loss: 295.2744993715031
Step: 531, Loss: 295.1400702678149
Step: 532, Loss: 295.00551018269357
Step: 533, Loss: 294.87081883931194
Step: 534, Loss: 294.73599596050803
Step: 535, Loss: 294.60104126877536
Step: 536, Loss: 294.4659544862533
Step: 537, Loss: 294.33073533471713
Step: 538, Loss: 294.19538353556914
Step: 539, Loss: 294.05989880982906
Step: 540, Loss: 293.92428087812493
Step: 541, Loss: 293.78852946068423
Step: 542, Loss: 293.65264427732484
Step: 543, Loss: 293.51662504744604
Step: 544, Loss: 293.3804714900203
Step: 545, Loss: 293.2441833235845
Step: 546, Loss: 293.10776026623125
Step: 547, Loss: 292.9712020356009
Step: 548, Loss: 292.8345083488732
Step: 549, Loss: 292.6976789227592
Step: 550, Loss: 292.5607134734929
Step: 551, Loss: 292.4236117168241
Step: 552, Loss: 292.28637336800955
Step: 553, Loss: 292.14899814180626
Step: 554, Loss: 292.01148575246316
Step: 555, Loss: 291.8738359137139
Step: 556, Loss: 291.73604833876936
Step: 557, Loss: 291.59812274031015
Step: 558, Loss: 291.4600588304795
Step: 559, Loss: 291.32185632087635
Step: 560, Loss: 291.1835149225475
Step: 561, Loss: 291.0450343459814
Step: 562, Loss: 290.9064143011007
Step: 563, Loss: 290.7676544972559
Step: 564, Loss: 290.6287546432178
Step: 565, Loss: 290.4897144471719
Step: 566, Loss: 290.3505336167105
Step: 567, Loss: 290.2112118588273
Step: 568, Loss: 290.07174887991033
Step: 569, Loss: 289.93214438573534
Step: 570, Loss: 289.79239808146
Step: 571, Loss: 289.65250967161734
Step: 572, Loss: 289.51247886010947
Step: 573, Loss: 289.37230535020154
Step: 574, Loss: 289.2319888445155
Step: 575, Loss: 289.0915290450243
Step: 576, Loss: 288.95092565304554
Step: 577, Loss: 288.8101783692359
Step: 578, Loss: 288.66928689358525
Step: 579, Loss: 288.52825092541025
Step: 580, Loss: 288.38707016334945
Step: 581, Loss: 288.2457443053569
Step: 582, Loss: 288.10427304869677
Step: 583, Loss: 287.9626560899376
Step: 584, Loss: 287.8208931249467
Step: 585, Loss: 287.67898384888485
Step: 586, Loss: 287.5369279562005
Step: 587, Loss: 287.39472514062436
Step: 588, Loss: 287.25237509516404
Step: 589, Loss: 287.1098775120988
Step: 590, Loss: 286.9672320829741
Step: 591, Loss: 286.82443849859595
Step: 592, Loss: 286.6814964490263
Step: 593, Loss: 286.5384056235772
Step: 594, Loss: 286.395165710806
Step: 595, Loss: 286.2517763985099
Step: 596, Loss: 286.10823737372084
Step: 597, Loss: 285.9645483227007
Step: 598, Loss: 285.82070893093567
Step: 599, Loss: 285.67671888313174
Step: 600, Loss: 285.5325778632092
Step: 601, Loss: 285.3882855542979
Step: 602, Loss: 285.24384163873214
Step: 603, Loss: 285.0992457980458
Step: 604, Loss: 284.9544977129673
Step: 605, Loss: 284.8095970634147
Step: 606, Loss: 284.66454352849075
Step: 607, Loss: 284.51933678647833
Step: 608, Loss: 284.373976514835
Step: 609, Loss: 284.22846239018867
Step: 610, Loss: 284.0827940883323
Step: 611, Loss: 283.9369712842198
Step: 612, Loss: 283.7909936519602
Step: 613, Loss: 283.6448608648139
Step: 614, Loss: 283.49857259518717
Step: 615, Loss: 283.35212851462785
Step: 616, Loss: 283.20552829381984
Step: 617, Loss: 283.0587716025797
Step: 618, Loss: 282.9118581098506
Step: 619, Loss: 282.7647874836982
Step: 620, Loss: 282.6175593913058
Step: 621, Loss: 282.4701734989698
Step: 622, Loss: 282.3226294720949
Step: 623, Loss: 282.17492697518935
Step: 624, Loss: 282.02706567186027
Step: 625, Loss: 281.8790452248089
Step: 626, Loss: 281.73086529582633
Step: 627, Loss: 281.5825255457883
Step: 628, Loss: 281.43402563465077
Step: 629, Loss: 281.28536522144526
Step: 630, Loss: 281.1365439642742
Step: 631, Loss: 280.98756152030626
Step: 632, Loss: 280.83841754577156
Step: 633, Loss: 280.689111695957
Step: 634, Loss: 280.5396436252023
Step: 635, Loss: 280.39001298689396
Step: 636, Loss: 280.24021943346185
Step: 637, Loss: 280.09026261637393
Step: 638, Loss: 279.940142186132
Step: 639, Loss: 279.7898577922665
Step: 640, Loss: 279.639409083332
Step: 641, Loss: 279.48879570690315
Step: 642, Loss: 279.3380173095689
Step: 643, Loss: 279.1870735369289
Step: 644, Loss: 279.0359640335881
Step: 645, Loss: 278.88468844315224
Step: 646, Loss: 278.73324640822335
Step: 647, Loss: 278.58163757039483
Step: 648, Loss: 278.4298615702469
Step: 649, Loss: 278.2779180473416
Step: 650, Loss: 278.12580664021846
Step: 651, Loss: 277.9735269863895
Step: 652, Loss: 277.82107872233473
Step: 653, Loss: 277.6684614834969
Step: 654, Loss: 277.51567490427755
Step: 655, Loss: 277.36271861803147
Step: 656, Loss: 277.2095922570624
Step: 657, Loss: 277.0562954526181
Step: 658, Loss: 276.9028278348856
Step: 659, Loss: 276.74918903298624
Step: 660, Loss: 276.5953786749712
Step: 661, Loss: 276.44139638781627
Step: 662, Loss: 276.28724179741744
Step: 663, Loss: 276.13291452858573
Step: 664, Loss: 275.97841420504244
Step: 665, Loss: 275.82374044941434
Step: 666, Loss: 275.66889288322875
Step: 667, Loss: 275.51387112690867
Step: 668, Loss: 275.35867479976787
Step: 669, Loss: 275.203303520006
Step: 670, Loss: 275.0477569047034
Step: 671, Loss: 274.8920345698168
Step: 672, Loss: 274.7361361301737
Step: 673, Loss: 274.58006119946765
Step: 674, Loss: 274.4238093902535
Step: 675, Loss: 274.267380313942
Step: 676, Loss: 274.11077358079496
Step: 677, Loss: 273.9539887999204
Step: 678, Loss: 273.79702557926726
Step: 679, Loss: 273.6398835256206
Step: 680, Loss: 273.48256224459595
Step: 681, Loss: 273.3250613406354
Step: 682, Loss: 273.167380417001
Step: 683, Loss: 273.0095190757709
Step: 684, Loss: 272.85147691783357
Step: 685, Loss: 272.69325354288253
Step: 686, Loss: 272.5348485494119
Step: 687, Loss: 272.37626153471064
Step: 688, Loss: 272.2174920948572
Step: 689, Loss: 272.0585398247151
Step: 690, Loss: 271.8994043179268
Step: 691, Loss: 271.74008516690895
Step: 692, Loss: 271.58058196284696
Step: 693, Loss: 271.42089429569006
Step: 694, Loss: 271.2610217541454
Step: 695, Loss: 271.1009639256731
Step: 696, Loss: 270.940720396481
Step: 697, Loss: 270.78029075151915
Step: 698, Loss: 270.6196745744742
Step: 699, Loss: 270.45887144776435
Step: 700, Loss: 270.2978809525342
Step: 701, Loss: 270.13670266864847
Step: 702, Loss: 269.97533617468736
Step: 703, Loss: 269.81378104794044
Step: 704, Loss: 269.65203686440196
Step: 705, Loss: 269.4901031987646
Step: 706, Loss: 269.32797962441396
Step: 707, Loss: 269.16566571342366
Step: 708, Loss: 269.0031610365493
Step: 709, Loss: 268.8404651632227
Step: 710, Loss: 268.6775776615468
Step: 711, Loss: 268.5144980982898
Step: 712, Loss: 268.3512260388791
Step: 713, Loss: 268.1877610473965
Step: 714, Loss: 268.0241026865717
Step: 715, Loss: 267.86025051777716
Step: 716, Loss: 267.69620410102186
Step: 717, Loss: 267.53196299494596
Step: 718, Loss: 267.36752675681487
Step: 719, Loss: 267.20289494251347
Step: 720, Loss: 267.03806710654015
Step: 721, Loss: 266.87304280200135
Step: 722, Loss: 266.7078215806053
Step: 723, Loss: 266.54240299265626
Step: 724, Loss: 266.37678658704874
Step: 725, Loss: 266.2109719112615
Step: 726, Loss: 266.0449585113515
Step: 727, Loss: 265.878745931948
Step: 728, Loss: 265.7123337162468
Step: 729, Loss: 265.54572140600357
Step: 730, Loss: 265.37890854152886
Step: 731, Loss: 265.21189466168073
Step: 732, Loss: 265.04467930386005
Step: 733, Loss: 264.8772620040032
Step: 734, Loss: 264.7096422965767
Step: 735, Loss: 264.54181971457064
Step: 736, Loss: 264.3737937894928
Step: 737, Loss: 264.20556405136233
Step: 738, Loss: 264.03713002870336
Step: 739, Loss: 263.86849124853893
Step: 740, Loss: 263.699647236385
Step: 741, Loss: 263.53059751624335
Step: 742, Loss: 263.3613416105961
Step: 743, Loss: 263.19187904039904
Step: 744, Loss: 263.022209325075
Step: 745, Loss: 262.85233198250796
Step: 746, Loss: 262.6822465290362
Step: 747, Loss: 262.5119524794461
Step: 748, Loss: 262.34144934696565
Step: 749, Loss: 262.170736643258
Step: 750, Loss: 261.99981387841456
Step: 751, Loss: 261.8286805609492
Step: 752, Loss: 261.6573361977908
Step: 753, Loss: 261.48578029427756
Step: 754, Loss: 261.31401235414967
Step: 755, Loss: 261.14203187954297
Step: 756, Loss: 260.96983837098225
Step: 757, Loss: 260.79743132737474
Step: 758, Loss: 260.6248102460031
Step: 759, Loss: 260.45197462251855
Step: 760, Loss: 260.2789239509348
Step: 761, Loss: 260.10565772362065
Step: 762, Loss: 259.9321754312932
Step: 763, Loss: 259.7584765630111
Step: 764, Loss: 259.584560606168
Step: 765, Loss: 259.4104270464851
Step: 766, Loss: 259.23607536800466
Step: 767, Loss: 259.06150505308256
Step: 768, Loss: 258.8867155823823
Step: 769, Loss: 258.7117064348668
Step: 770, Loss: 258.5364770877919
Step: 771, Loss: 258.36102701669967
Step: 772, Loss: 258.18535569541064
Step: 773, Loss: 258.00946259601744
Step: 774, Loss: 257.83334718887676
Step: 775, Loss: 257.65700894260317
Step: 776, Loss: 257.480447324061
Step: 777, Loss: 257.30366179835784
Step: 778, Loss: 257.12665182883705
Step: 779, Loss: 256.94941687707035
Step: 780, Loss: 256.7719564028506
Step: 781, Loss: 256.5942698641847
Step: 782, Loss: 256.416356717286
Step: 783, Loss: 256.23821641656684
Step: 784, Loss: 256.0598484146313
Step: 785, Loss: 255.88125216226786
Step: 786, Loss: 255.70242710844178
Step: 787, Loss: 255.52337270028778
Step: 788, Loss: 255.34408838310213
Step: 789, Loss: 255.16457360033553
Step: 790, Loss: 254.9848277935854
Step: 791, Loss: 254.80485040258822
Step: 792, Loss: 254.62464086521186
Step: 793, Loss: 254.4441986174483
Step: 794, Loss: 254.26352309340535
Step: 795, Loss: 254.08261372529938
Step: 796, Loss: 253.90146994344747
Step: 797, Loss: 253.72009117625953
Step: 798, Loss: 253.5384768502307
Step: 799, Loss: 253.35662638993338
Step: 800, Loss: 253.17453921800941
Step: 801, Loss: 252.9922147551623
Step: 802, Loss: 252.809652420149
Step: 803, Loss: 252.62685162977243
Step: 804, Loss: 252.44381179887324
Step: 805, Loss: 252.26053234032173
Step: 806, Loss: 252.07701266501005
Step: 807, Loss: 251.8932521818442
Step: 808, Loss: 251.70925029773554
Step: 809, Loss: 251.52500641759326
Step: 810, Loss: 251.3405199443156
Step: 811, Loss: 251.15579027878243
Step: 812, Loss: 250.9708168198464
Step: 813, Loss: 250.78559896432506
Step: 814, Loss: 250.60013610699272
Step: 815, Loss: 250.4144276405717
Step: 816, Loss: 250.22847295572458
Step: 817, Loss: 250.04227144104573
Step: 818, Loss: 249.85582248305258
Step: 819, Loss: 249.6691254661776
Step: 820, Loss: 249.48217977275993
Step: 821, Loss: 249.29498478303674
Step: 822, Loss: 249.10753987513473
Step: 823, Loss: 248.9198444250619
Step: 824, Loss: 248.73189780669878
Step: 825, Loss: 248.54369939178997
Step: 826, Loss: 248.35524854993548
Step: 827, Loss: 248.16654464858237
Step: 828, Loss: 247.97758705301584
Step: 829, Loss: 247.78837512635062
Step: 830, Loss: 247.59890822952238
Step: 831, Loss: 247.4091857212789
Step: 832, Loss: 247.21920695817172
Step: 833, Loss: 247.0289712945465
Step: 834, Loss: 246.8384780825351
Step: 835, Loss: 246.64772667204642
Step: 836, Loss: 246.45671641075745
Step: 837, Loss: 246.2654466441045
Step: 838, Loss: 246.07391671527415
Step: 839, Loss: 245.88212596519475
Step: 840, Loss: 245.6900737325269
Step: 841, Loss: 245.49775935365483
Step: 842, Loss: 245.30518216267728
Step: 843, Loss: 245.11234149139838
Step: 844, Loss: 244.9192366693188
Step: 845, Loss: 244.7258670236264
Step: 846, Loss: 244.5322318791872
Step: 847, Loss: 244.33833055853665
Step: 848, Loss: 244.1441623818696
Step: 849, Loss: 243.949726667032
Step: 850, Loss: 243.75502272951104
Step: 851, Loss: 243.5600498824262
Step: 852, Loss: 243.3648074365202
Step: 853, Loss: 243.169294700149
Step: 854, Loss: 242.9735109792735
Step: 855, Loss: 242.77745557744927
Step: 856, Loss: 242.5811277958174
Step: 857, Loss: 242.38452693309586
Step: 858, Loss: 242.18765228556896
Step: 859, Loss: 241.9905031470787
Step: 860, Loss: 241.79307880901527
Step: 861, Loss: 241.59537856030693
Step: 862, Loss: 241.3974016874114
Step: 863, Loss: 241.19914747430565
Step: 864, Loss: 241.00061520247678
Step: 865, Loss: 240.80180415091212
Step: 866, Loss: 240.60271359609004
Step: 867, Loss: 240.40334281196988
Step: 868, Loss: 240.2036910699827
Step: 869, Loss: 240.00375763902161
Step: 870, Loss: 239.8035417854316
Step: 871, Loss: 239.60304277300057
Step: 872, Loss: 239.40225986294928
Step: 873, Loss: 239.2011923139216
Step: 874, Loss: 238.9998393819748
Step: 875, Loss: 238.79820032056966
Step: 876, Loss: 238.59627438056103
Step: 877, Loss: 238.3940608101878
Step: 878, Loss: 238.19155885506302
Step: 879, Loss: 237.98876775816424
Step: 880, Loss: 237.7856867598237
Step: 881, Loss: 237.5823150977182
Step: 882, Loss: 237.37865200685945
Step: 883, Loss: 237.17469671958412
Step: 884, Loss: 236.97044846554394
Step: 885, Loss: 236.7659064716958
Step: 886, Loss: 236.5610699622919
Step: 887, Loss: 236.35593815886955
Step: 888, Loss: 236.1505102802413
Step: 889, Loss: 235.9447855424854
Step: 890, Loss: 235.73876315893506
Step: 891, Loss: 235.53244234016904
Step: 892, Loss: 235.32582229400163
Step: 893, Loss: 235.1189022254723
Step: 894, Loss: 234.91168133683607
Step: 895, Loss: 234.704158827553
Step: 896, Loss: 234.49633389427873
Step: 897, Loss: 234.2882057308543
Step: 898, Loss: 234.07977352829548
Step: 899, Loss: 233.87103647478378
Step: 900, Loss: 233.66199375565554
Step: 901, Loss: 233.4526445533921
Step: 902, Loss: 233.24298804761037
Step: 903, Loss: 233.0330234150515
Step: 904, Loss: 232.8227498295721
Step: 905, Loss: 232.61216646213325
Step: 906, Loss: 232.40127248079122
Step: 907, Loss: 232.19006705068674
Step: 908, Loss: 231.97854933403516
Step: 909, Loss: 231.7667184901168
Step: 910, Loss: 231.55457367526594
Step: 911, Loss: 231.34211404286216
Step: 912, Loss: 231.12933874331904
Step: 913, Loss: 230.91624692407467
Step: 914, Loss: 230.70283772958157
Step: 915, Loss: 230.4891103012969
Step: 916, Loss: 230.2750637776719
Step: 917, Loss: 230.06069729414264
Step: 918, Loss: 229.8460099831193
Step: 919, Loss: 229.63100097397674
Step: 920, Loss: 229.41566939304408
Step: 921, Loss: 229.20001436359541
Step: 922, Loss: 228.98403500583925
Step: 923, Loss: 228.76773043690878
Step: 924, Loss: 228.55109977085226
Step: 925, Loss: 228.334142118623
Step: 926, Loss: 228.1168565880693
Step: 927, Loss: 227.89924228392493
Step: 928, Loss: 227.68129830779935
Step: 929, Loss: 227.4630237581674
Step: 930, Loss: 227.2444177303605
Step: 931, Loss: 227.02547931655596
Step: 932, Loss: 226.80620760576818
Step: 933, Loss: 226.58660168383835
Step: 934, Loss: 226.36666063342506
Step: 935, Loss: 226.14638353399477
Step: 936, Loss: 225.92576946181214
Step: 937, Loss: 225.70481748993086
Step: 938, Loss: 225.48352668818364
Step: 939, Loss: 225.26189612317336
Step: 940, Loss: 225.03992485826313
Step: 941, Loss: 224.81761195356748
Step: 942, Loss: 224.59495646594272
Step: 943, Loss: 224.37195744897798
Step: 944, Loss: 224.1486139529855
Step: 945, Loss: 223.9249250249922
Step: 946, Loss: 223.7008897087302
Step: 947, Loss: 223.47650704462785
Step: 948, Loss: 223.2517760698006
Step: 949, Loss: 223.02669581804258
Step: 950, Loss: 222.80126531981725
Step: 951, Loss: 222.57548360224905
Step: 952, Loss: 222.34934968911415
Step: 953, Loss: 222.12286260083255
Step: 954, Loss: 221.8960213544587
Step: 955, Loss: 221.66882496367396
Step: 956, Loss: 221.4412724387771
Step: 957, Loss: 221.2133627866771
Step: 958, Loss: 220.9850950108839
Step: 959, Loss: 220.756468111501
Step: 960, Loss: 220.52748108521698
Step: 961, Loss: 220.2981329252975
Step: 962, Loss: 220.06842262157778
Step: 963, Loss: 219.8383491604544
Step: 964, Loss: 219.60791152487772
Step: 965, Loss: 219.37710869434437
Step: 966, Loss: 219.14593964488998
Step: 967, Loss: 218.91440334908117
Step: 968, Loss: 218.68249877600897
Step: 969, Loss: 218.45022489128132
Step: 970, Loss: 218.21758065701593
Step: 971, Loss: 217.9845650318338
Step: 972, Loss: 217.75117697085187
Step: 973, Loss: 217.51741542567703
Step: 974, Loss: 217.2832793443988
Step: 975, Loss: 217.0487676715836
Step: 976, Loss: 216.81387934826842
Step: 977, Loss: 216.57861331195411
Step: 978, Loss: 216.34296849660035
Step: 979, Loss: 216.10694383261915
Step: 980, Loss: 215.87053824686927
Step: 981, Loss: 215.63375066265084
Step: 982, Loss: 215.39657999970055
Step: 983, Loss: 215.15902517418525
Step: 984, Loss: 214.92108509869814
Step: 985, Loss: 214.68275868225328
Step: 986, Loss: 214.4440448302814
Step: 987, Loss: 214.20494244462478
Step: 988, Loss: 213.96545042353387
Step: 989, Loss: 213.72556766166252
Step: 990, Loss: 213.48529305006429
Step: 991, Loss: 213.24462547618919
Step: 992, Loss: 213.0035638238794
Step: 993, Loss: 212.7621069733669
Step: 994, Loss: 212.52025380126997
Step: 995, Loss: 212.27800318059036
Step: 996, Loss: 212.035353980711
Step: 997, Loss: 211.7923050673935
Step: 998, Loss: 211.54885530277605
Step: 999, Loss: 211.3050035453719
The GP took 3.4697489738464355 seconds to train.
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="nb">print</span><span class="p">(</span><span class="s2">&quot;loss&quot;</span><span class="p">,</span> <span class="n">gp</span><span class="o">.</span><span class="n">loss</span><span class="p">()</span><span class="o">.</span><span class="n">detach</span><span class="p">()</span><span class="o">.</span><span class="n">numpy</span><span class="p">())</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>loss 211.3050035453719
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">for</span> <span class="n">name</span><span class="p">,</span> <span class="n">value</span> <span class="ow">in</span> <span class="n">gp</span><span class="o">.</span><span class="n">named_parameters</span><span class="p">():</span>
    <span class="nb">print</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="n">value</span><span class="o">.</span><span class="n">detach</span><span class="p">()</span><span class="o">.</span><span class="n">numpy</span><span class="p">())</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>sigma_n [-0.94659174]
kernel.first.length_scale [-0.47920626]
kernel.first.sigma_s [1.06965014]
kernel.second.sigma_n [0.92854813]
</pre></div>
</div>
</div>
</div>
<p>Writing down this entire machinery every single time we want to use Gaussian processes and e.g. train them with inference algorithms is hugely unproductive, and as such researchers started writing libraries to abstract away the lower layers of the implementation, and be able to implement their Gaussian Processes with <strong>much fewer lines of code</strong>, and <strong>much faster implementations</strong>.</p>
<p>With which we can see some of the key properties of Gaussian process regression:</p>
<ul class="simple">
<li><p>It can interpolate data-points</p></li>
<li><p>The prediction variance does not depend on the observations</p></li>
<li><p>The mean predictor does not depend on the variance parameter</p></li>
<li><p>The mean tends to come back to zero when predicting far away from the observations</p></li>
<li><p>Data-efficient models</p></li>
<li><p>Immediate quantification of uncertainties in our model, which is highly welcome in downstream applications in engineering and the sciences</p></li>
</ul>
<p>The complexity of the Gaussian process regression is a limit though. As we saw in the implementation from scratch we need to store the covariance matrix, which results in a storage footprint of <span class="math notranslate nohighlight">\(\mathcal{O}(n^{2})\)</span> and have to invert the covariance matrix using the Cholesky factorization and applying triangular solves which is of computational complexity <span class="math notranslate nohighlight">\(\mathcal{O}(n^{3})\)</span>. We are hence limited to much fewer datapoints than we would usually witness in neural network models. This is the reason why practitioners resort to spare matrix-math when dealing with large datasets.</p>
</section>
<section id="gaussian-processes-in-pyro">
<h2><span class="section-number">5.3. </span>Gaussian Processes in Pyro<a class="headerlink" href="#gaussian-processes-in-pyro" title="Permalink to this heading">#</a></h2>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Helper library to more efficiently handle Gaussian Processes in PyTorch</span>
<span class="kn">import</span> <span class="nn">pyro</span>
<span class="kn">import</span> <span class="nn">pyro.contrib.gp</span> <span class="k">as</span> <span class="nn">gp</span>
<span class="kn">import</span> <span class="nn">pyro.distributions</span> <span class="k">as</span> <span class="nn">dist</span>

<span class="n">pyro</span><span class="o">.</span><span class="n">set_rng_seed</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stderr highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>/Users/cielo/venvs/sciml/lib/python3.9/site-packages/tqdm/auto.py:21: TqdmWarning: IProgress not found. Please update jupyter and ipywidgets. See https://ipywidgets.readthedocs.io/en/stable/user_install.html
  from .autonotebook import tqdm as notebook_tqdm
</pre></div>
</div>
</div>
</div>
<section id="helper-function-for-plotting">
<h3><span class="section-number">5.3.1. </span>Helper Function for Plotting<a class="headerlink" href="#helper-function-for-plotting" title="Permalink to this heading">#</a></h3>
<p>We first define a helper function for the plotting which allow us to</p>
<ul class="simple">
<li><p>Plot the observed data</p></li>
<li><p>Plot the prediction from the learned GP after conditioning on the data</p></li>
<li><p>Plot the samples from the GP prior</p></li>
</ul>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">plot</span><span class="p">(</span>
    <span class="n">plot_observed_data</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
    <span class="n">plot_predictions</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
    <span class="n">n_prior_samples</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span>
    <span class="n">model</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
    <span class="n">kernel</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
    <span class="n">n_test</span><span class="o">=</span><span class="mi">500</span><span class="p">,</span>
    <span class="n">ax</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
<span class="p">):</span>

    <span class="k">if</span> <span class="n">ax</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">fig</span><span class="p">,</span> <span class="n">ax</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">12</span><span class="p">,</span> <span class="mi">6</span><span class="p">))</span>
    <span class="k">if</span> <span class="n">plot_observed_data</span><span class="p">:</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">X</span><span class="o">.</span><span class="n">numpy</span><span class="p">(),</span> <span class="n">y</span><span class="o">.</span><span class="n">numpy</span><span class="p">(),</span> <span class="s2">&quot;kx&quot;</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">plot_predictions</span><span class="p">:</span>
        <span class="n">Xtest</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="o">-</span><span class="mf">0.5</span><span class="p">,</span> <span class="mf">5.5</span><span class="p">,</span> <span class="n">n_test</span><span class="p">)</span>  <span class="c1"># test inputs</span>
        <span class="c1"># compute predictive mean and variance</span>
        <span class="k">with</span> <span class="n">torch</span><span class="o">.</span><span class="n">no_grad</span><span class="p">():</span>
            <span class="k">if</span> <span class="nb">type</span><span class="p">(</span><span class="n">model</span><span class="p">)</span> <span class="o">==</span> <span class="n">gp</span><span class="o">.</span><span class="n">models</span><span class="o">.</span><span class="n">VariationalSparseGP</span><span class="p">:</span>
                <span class="n">mean</span><span class="p">,</span> <span class="n">cov</span> <span class="o">=</span> <span class="n">model</span><span class="p">(</span><span class="n">Xtest</span><span class="p">,</span> <span class="n">full_cov</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">mean</span><span class="p">,</span> <span class="n">cov</span> <span class="o">=</span> <span class="n">model</span><span class="p">(</span><span class="n">Xtest</span><span class="p">,</span> <span class="n">full_cov</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">noiseless</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
        <span class="n">sd</span> <span class="o">=</span> <span class="n">cov</span><span class="o">.</span><span class="n">diag</span><span class="p">()</span><span class="o">.</span><span class="n">sqrt</span><span class="p">()</span>  <span class="c1"># standard deviation at each input point x</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">Xtest</span><span class="o">.</span><span class="n">numpy</span><span class="p">(),</span> <span class="n">mean</span><span class="o">.</span><span class="n">numpy</span><span class="p">(),</span> <span class="s2">&quot;r&quot;</span><span class="p">,</span> <span class="n">lw</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span>  <span class="c1"># plot the mean</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">fill_between</span><span class="p">(</span>
            <span class="n">Xtest</span><span class="o">.</span><span class="n">numpy</span><span class="p">(),</span>  <span class="c1"># plot the two-sigma uncertainty about the mean</span>
            <span class="p">(</span><span class="n">mean</span> <span class="o">-</span> <span class="mf">2.0</span> <span class="o">*</span> <span class="n">sd</span><span class="p">)</span><span class="o">.</span><span class="n">numpy</span><span class="p">(),</span>
            <span class="p">(</span><span class="n">mean</span> <span class="o">+</span> <span class="mf">2.0</span> <span class="o">*</span> <span class="n">sd</span><span class="p">)</span><span class="o">.</span><span class="n">numpy</span><span class="p">(),</span>
            <span class="n">color</span><span class="o">=</span><span class="s2">&quot;C0&quot;</span><span class="p">,</span>
            <span class="n">alpha</span><span class="o">=</span><span class="mf">0.3</span><span class="p">,</span>
        <span class="p">)</span>
    <span class="k">if</span> <span class="n">n_prior_samples</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>  <span class="c1"># plot samples from the GP prior</span>
        <span class="n">Xtest</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="o">-</span><span class="mf">0.5</span><span class="p">,</span> <span class="mf">5.5</span><span class="p">,</span> <span class="n">n_test</span><span class="p">)</span>  <span class="c1"># test inputs</span>
        <span class="n">noise</span> <span class="o">=</span> <span class="p">(</span>
            <span class="n">model</span><span class="o">.</span><span class="n">noise</span>
            <span class="k">if</span> <span class="nb">type</span><span class="p">(</span><span class="n">model</span><span class="p">)</span> <span class="o">!=</span> <span class="n">gp</span><span class="o">.</span><span class="n">models</span><span class="o">.</span><span class="n">VariationalSparseGP</span>
            <span class="k">else</span> <span class="n">model</span><span class="o">.</span><span class="n">likelihood</span><span class="o">.</span><span class="n">variance</span>
        <span class="p">)</span>
        <span class="n">cov</span> <span class="o">=</span> <span class="n">kernel</span><span class="o">.</span><span class="n">forward</span><span class="p">(</span><span class="n">Xtest</span><span class="p">)</span> <span class="o">+</span> <span class="n">noise</span><span class="o">.</span><span class="n">expand</span><span class="p">(</span><span class="n">n_test</span><span class="p">)</span><span class="o">.</span><span class="n">diag</span><span class="p">()</span>
        <span class="n">samples</span> <span class="o">=</span> <span class="n">dist</span><span class="o">.</span><span class="n">MultivariateNormal</span><span class="p">(</span>
            <span class="n">torch</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">n_test</span><span class="p">),</span> <span class="n">covariance_matrix</span><span class="o">=</span><span class="n">cov</span>
        <span class="p">)</span><span class="o">.</span><span class="n">sample</span><span class="p">(</span><span class="n">sample_shape</span><span class="o">=</span><span class="p">(</span><span class="n">n_prior_samples</span><span class="p">,))</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">Xtest</span><span class="o">.</span><span class="n">numpy</span><span class="p">(),</span> <span class="n">samples</span><span class="o">.</span><span class="n">numpy</span><span class="p">()</span><span class="o">.</span><span class="n">T</span><span class="p">,</span> <span class="n">lw</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.4</span><span class="p">)</span>

    <span class="n">ax</span><span class="o">.</span><span class="n">set_xlim</span><span class="p">(</span><span class="o">-</span><span class="mf">0.5</span><span class="p">,</span> <span class="mf">5.5</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
</section>
<section id="synthetic-dataset">
<h3><span class="section-number">5.3.2. </span>Synthetic Dataset<a class="headerlink" href="#synthetic-dataset" title="Permalink to this heading">#</a></h3>
<p>We begin by synthetically sampling a dataset of 50 points following the relation of</p>
<div class="math notranslate nohighlight">
\[
y = 0.5 \sin(3x) + \varepsilon, \quad \varepsilon \sim \mathcal{N}(0, 0.2)
\]</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">N</span> <span class="o">=</span> <span class="mi">50</span>
<span class="n">torch</span><span class="o">.</span><span class="n">manual_seed</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
<span class="n">X</span> <span class="o">=</span> <span class="n">dist</span><span class="o">.</span><span class="n">Uniform</span><span class="p">(</span><span class="mf">0.0</span><span class="p">,</span> <span class="mf">5.0</span><span class="p">)</span><span class="o">.</span><span class="n">sample</span><span class="p">(</span><span class="n">sample_shape</span><span class="o">=</span><span class="p">(</span><span class="n">N</span><span class="p">,))</span>
<span class="n">y</span> <span class="o">=</span> <span class="mf">0.5</span> <span class="o">*</span> <span class="n">torch</span><span class="o">.</span><span class="n">sin</span><span class="p">(</span><span class="mi">3</span> <span class="o">*</span> <span class="n">X</span><span class="p">)</span> <span class="o">+</span> <span class="n">dist</span><span class="o">.</span><span class="n">Normal</span><span class="p">(</span><span class="mf">0.0</span><span class="p">,</span> <span class="mf">0.2</span><span class="p">)</span><span class="o">.</span><span class="n">sample</span><span class="p">(</span><span class="n">sample_shape</span><span class="o">=</span><span class="p">(</span><span class="n">N</span><span class="p">,))</span>

<span class="n">plot</span><span class="p">(</span><span class="n">plot_observed_data</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="../_images/fcd16aca31ec016f098414e031afce5bee5f7acb0777a8ca23c64df52a7c3d05.png" src="../_images/fcd16aca31ec016f098414e031afce5bee5f7acb0777a8ca23c64df52a7c3d05.png" />
</div>
</div>
</section>
<section id="model-definition">
<h3><span class="section-number">5.3.3. </span>Model Definition<a class="headerlink" href="#model-definition" title="Permalink to this heading">#</a></h3>
<p>Beginning with the definition of the RBF kernel, we then construct a Gaussian Process regression object and sample from this prior without training it for our synthetic data.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">kernel</span> <span class="o">=</span> <span class="n">gp</span><span class="o">.</span><span class="n">kernels</span><span class="o">.</span><span class="n">RBF</span><span class="p">(</span>
    <span class="n">input_dim</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">variance</span><span class="o">=</span><span class="n">torch</span><span class="o">.</span><span class="n">tensor</span><span class="p">(</span><span class="mf">6.0</span><span class="p">),</span> <span class="n">lengthscale</span><span class="o">=</span><span class="n">torch</span><span class="o">.</span><span class="n">tensor</span><span class="p">(</span><span class="mf">0.05</span><span class="p">)</span>
<span class="p">)</span>
<span class="n">gpr</span> <span class="o">=</span> <span class="n">gp</span><span class="o">.</span><span class="n">models</span><span class="o">.</span><span class="n">GPRegression</span><span class="p">(</span><span class="n">X</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">kernel</span><span class="p">,</span> <span class="n">noise</span><span class="o">=</span><span class="n">torch</span><span class="o">.</span><span class="n">tensor</span><span class="p">(</span><span class="mf">0.1</span><span class="p">))</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">plot</span><span class="p">(</span><span class="n">model</span><span class="o">=</span><span class="n">gpr</span><span class="p">,</span> <span class="n">kernel</span><span class="o">=</span><span class="n">kernel</span><span class="p">,</span> <span class="n">n_prior_samples</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span>
<span class="n">_</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">ylim</span><span class="p">((</span><span class="o">-</span><span class="mi">8</span><span class="p">,</span> <span class="mi">8</span><span class="p">))</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="../_images/7ffa2ea4c7d134efc3710608fbff952b280bcee09ba572ae30c20be4ee3dd3ee.png" src="../_images/7ffa2ea4c7d134efc3710608fbff952b280bcee09ba572ae30c20be4ee3dd3ee.png" />
</div>
</div>
<ul class="simple">
<li><p>What would change if we increase the lengthscale? We will obtain much smoother function samples.</p></li>
<li><p>In reverse, this means that the shorter the lengthscale the more rugged our function samples are.</p></li>
<li><p>What happens if we reduce the variance and the noise? The vertical amplitude gets smaller and smaller.</p></li>
<li><p>In reverse, this means that the larger the variance and the noise, the larger the vertical amplitude of our function samples.</p></li>
</ul>
<p>In examples:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">kernel2</span> <span class="o">=</span> <span class="n">gp</span><span class="o">.</span><span class="n">kernels</span><span class="o">.</span><span class="n">RBF</span><span class="p">(</span>
    <span class="n">input_dim</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">variance</span><span class="o">=</span><span class="n">torch</span><span class="o">.</span><span class="n">tensor</span><span class="p">(</span><span class="mf">6.0</span><span class="p">),</span> <span class="n">lengthscale</span><span class="o">=</span><span class="n">torch</span><span class="o">.</span><span class="n">tensor</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
<span class="p">)</span>
<span class="n">gpr2</span> <span class="o">=</span> <span class="n">gp</span><span class="o">.</span><span class="n">models</span><span class="o">.</span><span class="n">GPRegression</span><span class="p">(</span><span class="n">X</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">kernel2</span><span class="p">,</span> <span class="n">noise</span><span class="o">=</span><span class="n">torch</span><span class="o">.</span><span class="n">tensor</span><span class="p">(</span><span class="mf">0.1</span><span class="p">))</span>
<span class="n">plot</span><span class="p">(</span><span class="n">model</span><span class="o">=</span><span class="n">gpr2</span><span class="p">,</span> <span class="n">kernel</span><span class="o">=</span><span class="n">kernel2</span><span class="p">,</span> <span class="n">n_prior_samples</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span>
<span class="n">_</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">ylim</span><span class="p">((</span><span class="o">-</span><span class="mi">8</span><span class="p">,</span> <span class="mi">8</span><span class="p">))</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="../_images/1f50f557496d0fb9c5b38a4bed0b874e67abff5fed7ae8b399d996d8f6c22494.png" src="../_images/1f50f557496d0fb9c5b38a4bed0b874e67abff5fed7ae8b399d996d8f6c22494.png" />
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">kernel3</span> <span class="o">=</span> <span class="n">gp</span><span class="o">.</span><span class="n">kernels</span><span class="o">.</span><span class="n">RBF</span><span class="p">(</span>
    <span class="n">input_dim</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">variance</span><span class="o">=</span><span class="n">torch</span><span class="o">.</span><span class="n">tensor</span><span class="p">(</span><span class="mf">1.0</span><span class="p">),</span> <span class="n">lengthscale</span><span class="o">=</span><span class="n">torch</span><span class="o">.</span><span class="n">tensor</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
<span class="p">)</span>
<span class="n">gpr3</span> <span class="o">=</span> <span class="n">gp</span><span class="o">.</span><span class="n">models</span><span class="o">.</span><span class="n">GPRegression</span><span class="p">(</span><span class="n">X</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">kernel3</span><span class="p">,</span> <span class="n">noise</span><span class="o">=</span><span class="n">torch</span><span class="o">.</span><span class="n">tensor</span><span class="p">(</span><span class="mf">0.01</span><span class="p">))</span>
<span class="n">plot</span><span class="p">(</span><span class="n">model</span><span class="o">=</span><span class="n">gpr3</span><span class="p">,</span> <span class="n">kernel</span><span class="o">=</span><span class="n">kernel3</span><span class="p">,</span> <span class="n">n_prior_samples</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span>
<span class="n">_</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">ylim</span><span class="p">((</span><span class="o">-</span><span class="mi">8</span><span class="p">,</span> <span class="mi">8</span><span class="p">))</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="../_images/ac300ce31ab57fbbfac19ceca3be5eef7bde7e964026e40ddab6b2239cab6eae.png" src="../_images/ac300ce31ab57fbbfac19ceca3be5eef7bde7e964026e40ddab6b2239cab6eae.png" />
</div>
</div>
</section>
<section id="inference">
<h3><span class="section-number">5.3.4. </span>Inference<a class="headerlink" href="#inference" title="Permalink to this heading">#</a></h3>
<p>To now adjust the kernel hyperparameters to our synthetic data, we have to perform inference. For this we define the Evidence-Lower-Bound (ELBO) and construct a scenario in which we essentially perform <strong>gradient ascent</strong> on the log marginal likelihood, i.e. we computationally solve the <strong>Marginal Likelihood Estimation (MLE)</strong> to infer the right model parameters.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">optimizer</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">optim</span><span class="o">.</span><span class="n">Adam</span><span class="p">(</span><span class="n">gpr</span><span class="o">.</span><span class="n">parameters</span><span class="p">(),</span> <span class="n">lr</span><span class="o">=</span><span class="mf">0.005</span><span class="p">)</span>
<span class="n">loss_fn</span> <span class="o">=</span> <span class="n">pyro</span><span class="o">.</span><span class="n">infer</span><span class="o">.</span><span class="n">Trace_ELBO</span><span class="p">()</span><span class="o">.</span><span class="n">differentiable_loss</span>
<span class="n">losses</span> <span class="o">=</span> <span class="p">[]</span>
<span class="n">variances</span> <span class="o">=</span> <span class="p">[]</span>
<span class="n">lengthscales</span> <span class="o">=</span> <span class="p">[]</span>
<span class="n">noises</span> <span class="o">=</span> <span class="p">[]</span>
<span class="n">num_steps</span> <span class="o">=</span> <span class="mi">2000</span>
<span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">num_steps</span><span class="p">):</span>
    <span class="n">variances</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">gpr</span><span class="o">.</span><span class="n">kernel</span><span class="o">.</span><span class="n">variance</span><span class="o">.</span><span class="n">item</span><span class="p">())</span>
    <span class="n">noises</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">gpr</span><span class="o">.</span><span class="n">noise</span><span class="o">.</span><span class="n">item</span><span class="p">())</span>
    <span class="n">lengthscales</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">gpr</span><span class="o">.</span><span class="n">kernel</span><span class="o">.</span><span class="n">lengthscale</span><span class="o">.</span><span class="n">item</span><span class="p">())</span>
    <span class="n">optimizer</span><span class="o">.</span><span class="n">zero_grad</span><span class="p">()</span>
    <span class="n">loss</span> <span class="o">=</span> <span class="n">loss_fn</span><span class="p">(</span><span class="n">gpr</span><span class="o">.</span><span class="n">model</span><span class="p">,</span> <span class="n">gpr</span><span class="o">.</span><span class="n">guide</span><span class="p">)</span>
    <span class="n">loss</span><span class="o">.</span><span class="n">backward</span><span class="p">()</span>
    <span class="n">optimizer</span><span class="o">.</span><span class="n">step</span><span class="p">()</span>
    <span class="n">losses</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">loss</span><span class="o">.</span><span class="n">item</span><span class="p">())</span>
</pre></div>
</div>
</div>
</div>
<p>Plotting the loss curve after 2000 training iterations</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">plot_loss</span><span class="p">(</span><span class="n">loss</span><span class="p">):</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">loss</span><span class="p">)</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="s2">&quot;Iterations&quot;</span><span class="p">)</span>
    <span class="n">_</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="s2">&quot;Loss&quot;</span><span class="p">)</span>  <span class="c1"># supress output text</span>


<span class="n">plot_loss</span><span class="p">(</span><span class="n">losses</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="../_images/07a7c992884177037ff6dd842aaef6791520298bcd5f76409e1aa3dd32012462.png" src="../_images/07a7c992884177037ff6dd842aaef6791520298bcd5f76409e1aa3dd32012462.png" />
</div>
</div>
<p>With that the behaviour of our Gaussian Process should now be much more reasonable, letâ€™s inspect it</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">plot</span><span class="p">(</span><span class="n">model</span><span class="o">=</span><span class="n">gpr</span><span class="p">,</span> <span class="n">plot_observed_data</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">plot_predictions</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="../_images/c31a24620b88c171e382829122e57aa2c5d19103e3366237d721674700103d76.png" src="../_images/c31a24620b88c171e382829122e57aa2c5d19103e3366237d721674700103d76.png" />
</div>
</div>
<p>In this plot we have the typical case of GP representation:</p>
<ul class="simple">
<li><p>A, in this case red, line represents the mean prediction</p></li>
<li><p>A shaded area, in this case blue, represents the 2-sigma uncertainty around the mean</p></li>
</ul>
<p>But what are the actual hyperparameters we just learned?</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">gpr</span><span class="o">.</span><span class="n">kernel</span><span class="o">.</span><span class="n">variance</span><span class="o">.</span><span class="n">item</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>0.25187239303491094
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">gpr</span><span class="o">.</span><span class="n">kernel</span><span class="o">.</span><span class="n">lengthscale</span><span class="o">.</span><span class="n">item</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>0.524795243437157
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">gpr</span><span class="o">.</span><span class="n">noise</span><span class="o">.</span><span class="n">item</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>0.03603591991010109
</pre></div>
</div>
</div>
</div>
<p>The learning process can furthermore be illustrated for the GPâ€™s behaviour across training iterations:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">fig</span><span class="p">,</span> <span class="n">ax</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">12</span><span class="p">,</span> <span class="mi">6</span><span class="p">))</span>


<span class="k">def</span> <span class="nf">update</span><span class="p">(</span><span class="n">iteration</span><span class="p">):</span>
    <span class="n">pyro</span><span class="o">.</span><span class="n">clear_param_store</span><span class="p">()</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">cla</span><span class="p">()</span>
    <span class="n">kernel_iter</span> <span class="o">=</span> <span class="n">gp</span><span class="o">.</span><span class="n">kernels</span><span class="o">.</span><span class="n">RBF</span><span class="p">(</span>
        <span class="n">input_dim</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
        <span class="n">variance</span><span class="o">=</span><span class="n">torch</span><span class="o">.</span><span class="n">tensor</span><span class="p">(</span><span class="n">variances</span><span class="p">[</span><span class="n">iteration</span><span class="p">]),</span>
        <span class="n">lengthscale</span><span class="o">=</span><span class="n">torch</span><span class="o">.</span><span class="n">tensor</span><span class="p">(</span><span class="n">lengthscales</span><span class="p">[</span><span class="n">iteration</span><span class="p">]),</span>
    <span class="p">)</span>
    <span class="n">gpr_iter</span> <span class="o">=</span> <span class="n">gp</span><span class="o">.</span><span class="n">models</span><span class="o">.</span><span class="n">GPRegression</span><span class="p">(</span>
        <span class="n">X</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">kernel_iter</span><span class="p">,</span> <span class="n">noise</span><span class="o">=</span><span class="n">torch</span><span class="o">.</span><span class="n">tensor</span><span class="p">(</span><span class="n">noises</span><span class="p">[</span><span class="n">iteration</span><span class="p">])</span>
    <span class="p">)</span>
    <span class="n">plot</span><span class="p">(</span><span class="n">model</span><span class="o">=</span><span class="n">gpr_iter</span><span class="p">,</span> <span class="n">plot_observed_data</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">plot_predictions</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">ax</span><span class="o">=</span><span class="n">ax</span><span class="p">)</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Iteration: </span><span class="si">{</span><span class="n">iteration</span><span class="si">}</span><span class="s2">, Loss: </span><span class="si">{</span><span class="n">losses</span><span class="p">[</span><span class="n">iteration</span><span class="p">]</span><span class="si">:</span><span class="s2">0.2f</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>


<span class="n">anim</span> <span class="o">=</span> <span class="n">FuncAnimation</span><span class="p">(</span><span class="n">fig</span><span class="p">,</span> <span class="n">update</span><span class="p">,</span> <span class="n">frames</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">num_steps</span><span class="p">,</span> <span class="mi">30</span><span class="p">),</span> <span class="n">interval</span><span class="o">=</span><span class="mi">100</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>

<span class="n">anim</span><span class="o">.</span><span class="n">save</span><span class="p">(</span><span class="s2">&quot;../imgs/gpr-fit.gif&quot;</span><span class="p">,</span> <span class="n">fps</span><span class="o">=</span><span class="mi">60</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
</section>
<section id="maximum-a-posteriory-estimation-map">
<h3><span class="section-number">5.3.5. </span>Maximum a Posteriory Estimation (MAP)<a class="headerlink" href="#maximum-a-posteriory-estimation-map" title="Permalink to this heading">#</a></h3>
<p>A second option is then to use MAP estimation for which we need to define priors over our hyperparameters to then infer the <em>true</em> hyperparameters.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">pyro</span><span class="o">.</span><span class="n">clear_param_store</span><span class="p">()</span>
<span class="n">kernel</span> <span class="o">=</span> <span class="n">gp</span><span class="o">.</span><span class="n">kernels</span><span class="o">.</span><span class="n">RBF</span><span class="p">(</span>
    <span class="n">input_dim</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">variance</span><span class="o">=</span><span class="n">torch</span><span class="o">.</span><span class="n">tensor</span><span class="p">(</span><span class="mf">5.0</span><span class="p">),</span> <span class="n">lengthscale</span><span class="o">=</span><span class="n">torch</span><span class="o">.</span><span class="n">tensor</span><span class="p">(</span><span class="mf">10.0</span><span class="p">)</span>
<span class="p">)</span>
<span class="n">gpr</span> <span class="o">=</span> <span class="n">gp</span><span class="o">.</span><span class="n">models</span><span class="o">.</span><span class="n">GPRegression</span><span class="p">(</span><span class="n">X</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">kernel</span><span class="p">,</span> <span class="n">noise</span><span class="o">=</span><span class="n">torch</span><span class="o">.</span><span class="n">tensor</span><span class="p">(</span><span class="mf">1.0</span><span class="p">))</span>

<span class="c1"># Define the priors over our hyperparameters</span>
<span class="n">gpr</span><span class="o">.</span><span class="n">kernel</span><span class="o">.</span><span class="n">lengthscale</span> <span class="o">=</span> <span class="n">pyro</span><span class="o">.</span><span class="n">nn</span><span class="o">.</span><span class="n">PyroSample</span><span class="p">(</span><span class="n">dist</span><span class="o">.</span><span class="n">LogNormal</span><span class="p">(</span><span class="mf">0.0</span><span class="p">,</span> <span class="mf">1.0</span><span class="p">))</span>
<span class="n">gpr</span><span class="o">.</span><span class="n">kernel</span><span class="o">.</span><span class="n">variance</span> <span class="o">=</span> <span class="n">pyro</span><span class="o">.</span><span class="n">nn</span><span class="o">.</span><span class="n">PyroSample</span><span class="p">(</span><span class="n">dist</span><span class="o">.</span><span class="n">LogNormal</span><span class="p">(</span><span class="mf">0.0</span><span class="p">,</span> <span class="mf">1.0</span><span class="p">))</span>

<span class="n">optimizer</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">optim</span><span class="o">.</span><span class="n">Adam</span><span class="p">(</span><span class="n">gpr</span><span class="o">.</span><span class="n">parameters</span><span class="p">(),</span> <span class="n">lr</span><span class="o">=</span><span class="mf">0.005</span><span class="p">)</span>
<span class="n">loss_fn</span> <span class="o">=</span> <span class="n">pyro</span><span class="o">.</span><span class="n">infer</span><span class="o">.</span><span class="n">Trace_ELBO</span><span class="p">()</span><span class="o">.</span><span class="n">differentiable_loss</span>
<span class="n">losses</span> <span class="o">=</span> <span class="p">[]</span>
<span class="n">num_steps</span> <span class="o">=</span> <span class="mi">2000</span>
<span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">num_steps</span><span class="p">):</span>
    <span class="n">optimizer</span><span class="o">.</span><span class="n">zero_grad</span><span class="p">()</span>
    <span class="n">loss</span> <span class="o">=</span> <span class="n">loss_fn</span><span class="p">(</span><span class="n">gpr</span><span class="o">.</span><span class="n">model</span><span class="p">,</span> <span class="n">gpr</span><span class="o">.</span><span class="n">guide</span><span class="p">)</span>
    <span class="n">loss</span><span class="o">.</span><span class="n">backward</span><span class="p">()</span>
    <span class="n">optimizer</span><span class="o">.</span><span class="n">step</span><span class="p">()</span>
    <span class="n">losses</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">loss</span><span class="o">.</span><span class="n">item</span><span class="p">())</span>

<span class="n">plot_loss</span><span class="p">(</span><span class="n">losses</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="../_images/615416f6ad80ccb855d2a800759f1ff7a1f2f45aeabc4ffe0a4788a67ce359e0.png" src="../_images/615416f6ad80ccb855d2a800759f1ff7a1f2f45aeabc4ffe0a4788a67ce359e0.png" />
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">plot</span><span class="p">(</span><span class="n">model</span><span class="o">=</span><span class="n">gpr</span><span class="p">,</span> <span class="n">plot_observed_data</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">plot_predictions</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="../_images/f51fedb798f80382d93c7c8125816024baf6a602c523765e70061f5239311cf7.png" src="../_images/f51fedb798f80382d93c7c8125816024baf6a602c523765e70061f5239311cf7.png" />
</div>
</div>
<p>What we then realize is that due to the priors we have defined, we end up with different hyperparameters than under the Maximum Likelihood Estimation (MLE)</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">gpr</span><span class="o">.</span><span class="n">set_mode</span><span class="p">(</span><span class="s2">&quot;guide&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;variance = </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">gpr</span><span class="o">.</span><span class="n">kernel</span><span class="o">.</span><span class="n">variance</span><span class="p">))</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;lengthscale = </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">gpr</span><span class="o">.</span><span class="n">kernel</span><span class="o">.</span><span class="n">lengthscale</span><span class="p">))</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;noise = </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">gpr</span><span class="o">.</span><span class="n">noise</span><span class="p">))</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>variance = 0.24541736830257171
lengthscale = 0.5144261073855972
noise = 0.035988066300649386
</pre></div>
</div>
</div>
</div>
<p>For the choice of prior we would ideally like to select parameters which maximise the model likelihood, which is defined by</p>
<div class="math notranslate nohighlight">
\[
L = \Pi_{i=1}^{p} f(x_{i})
\]</div>
<p>For a single observation our likelihood would then be</p>
<div class="math notranslate nohighlight">
\[
L(\sigma^{2}, \theta) = \frac{1}{(2\pi)^{\frac{n}{2}} |k(x, x)|^{\frac{1}{2}}} \exp \left( - \frac{1}{2} F^{\top} k(x, x)^{-1} F \right)
\]</div>
<p>We hence seek to <strong>maximise</strong> the likelihood, or the log-likelihood with respect to the kernelâ€™s parameters in order to find the most well-suited prior. As priors encode our prior belief over the function to approximate, they are hugely important choices to make which later on determine the performance of our Gaussian process. The question one should hence ask in selecting kernels are:</p>
<ul class="simple">
<li><p>Is my data stationary?</p></li>
<li><p>Is it differentiable, if so what is itâ€™s regularity?</p></li>
<li><p>Do I expect any particular trends?</p></li>
<li><p>Do I expect periodicity, cycles, additivity, or other patterns?</p></li>
</ul>
</section>
<section id="gaussian-process-classification">
<h3><span class="section-number">5.3.6. </span>Gaussian Process Classification<a class="headerlink" href="#gaussian-process-classification" title="Permalink to this heading">#</a></h3>
<p>To use Gaussian Processes for classification we first need to a softmax to our function prior</p>
<div class="math notranslate nohighlight">
\[
p(y | f) = \text{Softmax}(f)
\]</div>
<p>or going further</p>
<div class="math notranslate nohighlight">
\[
y \sim \text{Categorical}\left( \text{Softmax}(f) \right)
\]</div>
<p>using one of Seabornâ€™s naturally provided datasets, the Iris dataset we can then construct a classification problem with 3 classes:</p>
<ol class="arabic simple" start="0">
<li><p>Setosa</p></li>
<li><p>Versicolor</p></li>
<li><p>Virginica</p></li>
</ol>
<p>with just the petal length, and the petal width as input featurs.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">df</span> <span class="o">=</span> <span class="n">sns</span><span class="o">.</span><span class="n">load_dataset</span><span class="p">(</span><span class="s2">&quot;iris&quot;</span><span class="p">)</span>
<span class="n">df</span><span class="o">.</span><span class="n">head</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>sepal_length</th>
      <th>sepal_width</th>
      <th>petal_length</th>
      <th>petal_width</th>
      <th>species</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>0</th>
      <td>5.1</td>
      <td>3.5</td>
      <td>1.4</td>
      <td>0.2</td>
      <td>setosa</td>
    </tr>
    <tr>
      <th>1</th>
      <td>4.9</td>
      <td>3.0</td>
      <td>1.4</td>
      <td>0.2</td>
      <td>setosa</td>
    </tr>
    <tr>
      <th>2</th>
      <td>4.7</td>
      <td>3.2</td>
      <td>1.3</td>
      <td>0.2</td>
      <td>setosa</td>
    </tr>
    <tr>
      <th>3</th>
      <td>4.6</td>
      <td>3.1</td>
      <td>1.5</td>
      <td>0.2</td>
      <td>setosa</td>
    </tr>
    <tr>
      <th>4</th>
      <td>5.0</td>
      <td>3.6</td>
      <td>1.4</td>
      <td>0.2</td>
      <td>setosa</td>
    </tr>
  </tbody>
</table>
</div></div></div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">X</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">from_numpy</span><span class="p">(</span>
    <span class="n">df</span><span class="p">[</span><span class="n">df</span><span class="o">.</span><span class="n">columns</span><span class="p">[</span><span class="mi">2</span><span class="p">:</span><span class="mi">4</span><span class="p">]]</span><span class="o">.</span><span class="n">values</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="s2">&quot;float32&quot;</span><span class="p">),</span>
<span class="p">)</span>
<span class="n">df</span><span class="p">[</span><span class="s2">&quot;species&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="s2">&quot;species&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="s2">&quot;category&quot;</span><span class="p">)</span>
<span class="c1"># encode the species as 0, 1, 2</span>
<span class="n">y</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">from_numpy</span><span class="p">(</span><span class="n">df</span><span class="p">[</span><span class="s2">&quot;species&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">cat</span><span class="o">.</span><span class="n">codes</span><span class="o">.</span><span class="n">values</span><span class="o">.</span><span class="n">copy</span><span class="p">())</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">plt</span><span class="o">.</span><span class="n">scatter</span><span class="p">(</span><span class="n">X</span><span class="p">[:,</span> <span class="mi">0</span><span class="p">],</span> <span class="n">X</span><span class="p">[:,</span> <span class="mi">1</span><span class="p">],</span> <span class="n">c</span><span class="o">=</span><span class="n">y</span><span class="p">,</span> <span class="n">cmap</span><span class="o">=</span><span class="n">plt</span><span class="o">.</span><span class="n">cm</span><span class="o">.</span><span class="n">Paired</span><span class="p">,</span> <span class="n">edgecolors</span><span class="o">=</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">))</span>
<span class="n">plt</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="s2">&quot;Feature 1 (Petal length)&quot;</span><span class="p">)</span>
<span class="n">_</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="s2">&quot;Feature 2 (Petal width)&quot;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="../_images/a7fcdda8fee1745935618f02ce6c77319196e05dba893f26eb5e59db227d798f.png" src="../_images/a7fcdda8fee1745935618f02ce6c77319196e05dba893f26eb5e59db227d798f.png" />
</div>
</div>
<p>Using the classical RBF-kernel</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">kernel</span> <span class="o">=</span> <span class="n">gp</span><span class="o">.</span><span class="n">kernels</span><span class="o">.</span><span class="n">RBF</span><span class="p">(</span><span class="n">input_dim</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span>
<span class="n">pyro</span><span class="o">.</span><span class="n">clear_param_store</span><span class="p">()</span>
<span class="n">likelihood</span> <span class="o">=</span> <span class="n">gp</span><span class="o">.</span><span class="n">likelihoods</span><span class="o">.</span><span class="n">MultiClass</span><span class="p">(</span><span class="n">num_classes</span><span class="o">=</span><span class="mi">3</span><span class="p">)</span>
<span class="c1"># Important -- we need to add latent_shape argument here to the number of classes we have in the data</span>
<span class="n">model</span> <span class="o">=</span> <span class="n">gp</span><span class="o">.</span><span class="n">models</span><span class="o">.</span><span class="n">VariationalGP</span><span class="p">(</span>
    <span class="n">X</span><span class="p">,</span>
    <span class="n">y</span><span class="p">,</span>
    <span class="n">kernel</span><span class="p">,</span>
    <span class="n">likelihood</span><span class="o">=</span><span class="n">likelihood</span><span class="p">,</span>
    <span class="n">whiten</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
    <span class="n">jitter</span><span class="o">=</span><span class="mf">1e-03</span><span class="p">,</span>
    <span class="n">latent_shape</span><span class="o">=</span><span class="n">torch</span><span class="o">.</span><span class="n">Size</span><span class="p">([</span><span class="mi">3</span><span class="p">]),</span>
<span class="p">)</span>
<span class="n">num_steps</span> <span class="o">=</span> <span class="mi">1000</span>
<span class="n">loss</span> <span class="o">=</span> <span class="n">gp</span><span class="o">.</span><span class="n">util</span><span class="o">.</span><span class="n">train</span><span class="p">(</span><span class="n">model</span><span class="p">,</span> <span class="n">num_steps</span><span class="o">=</span><span class="n">num_steps</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">plot_loss</span><span class="p">(</span><span class="n">loss</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="../_images/25116f2172209ba9ed8231554c63660765b1510b6f1dbb06ca07226d698b9519.png" src="../_images/25116f2172209ba9ed8231554c63660765b1510b6f1dbb06ca07226d698b9519.png" />
</div>
</div>
<p>With which we can now inspect the accuracy of our classifier</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">mean</span><span class="p">,</span> <span class="n">var</span> <span class="o">=</span> <span class="n">model</span><span class="p">(</span><span class="n">X</span><span class="p">)</span>
<span class="n">y_hat</span> <span class="o">=</span> <span class="n">model</span><span class="o">.</span><span class="n">likelihood</span><span class="p">(</span><span class="n">mean</span><span class="p">,</span> <span class="n">var</span><span class="p">)</span>

<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Accuracy: </span><span class="si">{</span><span class="p">(</span><span class="n">y_hat</span><span class="o">==</span><span class="n">y</span><span class="p">)</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span><span class="o">*</span><span class="mi">100</span><span class="o">/</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">y</span><span class="p">))</span><span class="w"> </span><span class="si">:</span><span class="s2">0.2f</span><span class="si">}</span><span class="s2">%&quot;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Accuracy: 94.00%
</pre></div>
</div>
</div>
</div>
<p>And can furthermore use the confusion matrix to assess the accuracy of our predictions</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">cm</span> <span class="o">=</span> <span class="n">confusion_matrix</span><span class="p">(</span><span class="n">y</span><span class="p">,</span> <span class="n">y_hat</span><span class="p">,</span> <span class="n">labels</span><span class="o">=</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">])</span>
<span class="n">ConfusionMatrixDisplay</span><span class="p">(</span><span class="n">cm</span><span class="p">)</span><span class="o">.</span><span class="n">plot</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>&lt;sklearn.metrics._plot.confusion_matrix.ConfusionMatrixDisplay at 0x32c50c7f0&gt;
</pre></div>
</div>
<img alt="../_images/e97ae1782b02505b121745da84045bed08c03e8a2a505398b9beb6086f87d099.png" src="../_images/e97ae1782b02505b121745da84045bed08c03e8a2a505398b9beb6086f87d099.png" />
</div>
</div>
</section>
<section id="gaussian-process-classification-the-tl-dr">
<h3><span class="section-number">5.3.7. </span>Gaussian Process Classification: The tl;dr<a class="headerlink" href="#gaussian-process-classification-the-tl-dr" title="Permalink to this heading">#</a></h3>
<p>Quickly summarizing GP classification (in a slightly different notation)</p>
<p>Based on the Bayesian methodology, where we have to assume an underlying prior distribution to guarantee smoothness with the final classifier then being a Bayesian classifier, which provides the best first for the observed data. The initial problem here is that our posterior is not directly Gaussian, as has to be presumed in a Gaussian process, i.e.</p>
<div class="math notranslate nohighlight">
\[
p(f_{X}|Y) = \frac{\mathcal{N}(f_{X};m, k) \prod_{j=1}^{n} \sigma(y_{j}f_{x_{j}})}{\int \mathcal{N}(f_{X};m, k) \prod_{j=1}^{n}\sigma(y_{j}f_{x_{j}}) df_{X}}
\]</div>
<p>with the log-probability</p>
<div class="math notranslate nohighlight">
\[    
\log p(f_{X}|Y) = - \frac{1}{2} f_{X}^{\top} k^{-1}_{XX} f_{X} + \sum_{j=1}^{n} \log \sigma(y_{j} f_{x_{j}}) + \text{ const.}
\]</div>
<p>We are then interested in the following moments of our probability distribution, which we first decompose as a conditional probability, i.e. <span class="math notranslate nohighlight">\(p(f, y) = p(y|f)p(f)\)</span></p>
<div class="math notranslate nohighlight">
\[
\mathbb{E}_{p}(1) = \int 1 \cdot p(y, f) df = Z \quad \text{the evidence}
\]</div>
<div class="math notranslate nohighlight">
\[
\mathbb{E}_{p(f|y)}(f) = \frac{1}{Z} \int 1 \cdot p(f, y) df = \bar{f} \quad \text{the mean}
\]</div>
<div class="math notranslate nohighlight">
\[
\mathbb{E}_{p(f|y)}(f^{2}) - \bar{f}^{2} = \frac{1}{Z} \int f^{2} \cdot p(f, y) df - \bar{f}^{2} = \text{var}(f) \quad \text{the variance}
\]</div>
<p><span class="math notranslate nohighlight">\(Z\)</span> is then used for hyperparameter tuning, <span class="math notranslate nohighlight">\(\bar{f}\)</span> gives us a point estimator, and <span class="math notranslate nohighlight">\(\text{var}(f)\)</span> is our error estimator. To gain a classification estimator with the Gaussian process estimator with the Gaussian Process framework, we have to utilize the Laplace approximation to gain a classification estimator. For the Gaussian Process framework we then have to find the maximum posterior probability for latent <span class="math notranslate nohighlight">\(f\)</span> at training points</p>
<div class="math notranslate nohighlight">
\[
\hat{f} = \arg \max \log p(f_{X}|y)
\]</div>
<p>by assigning approximate Gaussian posteriors at the training points</p>
<div class="math notranslate nohighlight">
\[
q(f_{X}) = \mathcal{N}(f_{X}; \hat{f}, \hat{\Sigma}).
\]</div>
<p>Our Laplace approximation <span class="math notranslate nohighlight">\(q\)</span> for the classification probability <span class="math notranslate nohighlight">\(p\)</span> is then given by</p>
<div class="math notranslate nohighlight">
\[
q(f_{X}|y) = \mathcal{N}(f_{X}; m_{x} + k_{xX} K_{XX}^{-1}(\hat{f} - m_{x}), k_{xx} - k_{xX} K_{XX}^{-1} k_{Xx} + k_{xX} K_{XX}^{-1} \hat{\Sigma} K_{XX}^{-1}k_{Xx}).
\]</div>
<p>With which we can then compute the label probabilities</p>
<div class="math notranslate nohighlight">
\[
\mathbb{E}_{p(f|y)[\pi_{x}]} \approx \mathbb{E}_{q}[\pi_{x}] = \int \sigma(f_{x}) q(f_{x}|y) df_{x} \quad \text{or} \quad \hat{\pi}_{x} = \sigma(\mathbb{E}(f_{x})).
\]</div>
<p>The Laplace approximation is only locally valid, working well within the logistic regression framework as the log posterior is concave and the structure of the link function yields an almost Gaussian posterior.</p>
<p>The training algorithm is then given by</p>
<div class="math notranslate nohighlight">
\[\begin{split}
\begin{align}
    &amp;1 \quad \text{procedure GP-Logistic-Train}(K_{XX}, m_{X}, y) \\
    &amp;2 \quad \quad f \longleftarrow m_{X} \quad \quad // \text{initialize} \\
    &amp;3 \quad \quad \text{while not converged do} \\
    &amp;4 \quad \quad \quad \quad r \longleftarrow \frac{y + 1}{2} - \sigma(f) \quad \quad // = \nabla \log p(y|f_{X}), \text{ gradient of log-likelihood} \\
    &amp;5 \quad \quad \quad \quad W \longleftarrow \text{diag}(\sigma(f) \odot (1 - \sigma(f))) \quad \quad // = - \nabla \nabla \log p(y|f_{X}), \text{ Hessian of log-likelihood}\\
    &amp;6 \quad \quad \quad \quad g \longleftarrow r - K_{XX}^{-1}(f - m_{X}) \quad \quad // \text{ compute gradient} \\
    &amp;7 \quad \quad \quad \quad H \longleftarrow - (W + K^{-1})^{-1} \quad \quad // \text{ compute inverse Hessian} \\
    &amp;8 \quad \quad \quad \quad \Delta \longleftarrow Hg \quad \quad // \text{ Newton step} \\
    &amp;9 \quad \quad \quad \quad f \longleftarrow f - \Delta \quad \quad // \text{ perform step} \\
    &amp;10 \quad \quad \quad \text{converged} \longleftarrow ||\Delta|| &lt; \epsilon \quad \quad // \text{ check for convergence} \\
    &amp;11 \quad \quad \text{end while} \\
    &amp;12 \quad \quad \text{return } f \\
    &amp;13 \quad \text{end procedure}
\end{align}
\end{split}\]</div>
<p>and the prediction algorithm is given by</p>
<div class="math notranslate nohighlight">
\[\begin{split}
\begin{align}
    &amp;1 \quad \text{procedure GP-Logistic-Predict}(\hat{f}, W, R, r, k, x) \quad \quad // \hat{f}, W, R = \text{Cholesky}(B), r \text{ handed over from training}\\
    &amp;2 \quad \quad \text{for } i=1, \ldots, \text{Length}(x) \text{ do} \\
    &amp;3 \quad \quad \quad \bar{f}_{i} \longleftarrow k_{x_{i}X}r \quad \quad // \text{mean prediction } (\text{note at minimum, } 0 = \nabla p(f_{X}|y) = r - K^{-1}_{XX}(f_{X} - m_{X})) \\
    &amp;4 \quad \quad \quad s \longleftarrow R^{-1}(W^{1/2}k_{Xx_{i}}) \quad \quad // \text{pre-computation allows this step in } \mathcal{O}(n^{2}) \\
    &amp;5 \quad \quad \quad v \longleftarrow k_{x_{i}x_{i}} - s^{\top}s \quad \quad // v = \text{cov}(f_{X}) \\
    &amp;6 \quad \quad \quad \bar{\pi}_{i} \longleftarrow \int \sigma(f_{i}) \mathcal{N}(f_{i}, \bar{f}_{i}, v)df_{i} \quad \quad // \text{predictive probability for class 1 is } p(y|\bar{f}) = \int p(y_{X}|f_{X})p(f_{X}| \bar{f})df_{X} \\
    &amp;7 \quad \quad \text{end for} \quad \quad // \text{entire loop is } \mathcal{O}(n^{2}m) \text{ for m test cases}\\
    &amp;8 \quad \quad \text{return } \bar{\pi}_{X} \\
    &amp;9 \quad \text{end procedure}
\end{align}
\end{split}\]</div>
<p>Gaussian classification does hence in summary amount to</p>
<ul class="simple">
<li><p>The model outputs are modeled as transformations of latent functions with Gaussian priors</p></li>
<li><p>The non-Gaussian likelihood, the posterior is hence also non-Gaussian resulting in inference being intractable</p></li>
<li><p>This requires us to utilize Laplace approximations</p></li>
<li><p>With the Laplace approximations we then obtain Gaussian posteriors on training points</p></li>
</ul>
</section>
<section id="combining-kernels">
<h3><span class="section-number">5.3.8. </span>Combining Kernels<a class="headerlink" href="#combining-kernels" title="Permalink to this heading">#</a></h3>
<p>Pyro provides utilities to combine the different kernels, the most important of which are shown by example below:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">linear</span> <span class="o">=</span> <span class="n">gp</span><span class="o">.</span><span class="n">kernels</span><span class="o">.</span><span class="n">Linear</span><span class="p">(</span>
    <span class="n">input_dim</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
<span class="p">)</span>
<span class="n">periodic</span> <span class="o">=</span> <span class="n">gp</span><span class="o">.</span><span class="n">kernels</span><span class="o">.</span><span class="n">Periodic</span><span class="p">(</span>
    <span class="n">input_dim</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">period</span><span class="o">=</span><span class="n">torch</span><span class="o">.</span><span class="n">tensor</span><span class="p">(</span><span class="mf">0.5</span><span class="p">),</span> <span class="n">lengthscale</span><span class="o">=</span><span class="n">torch</span><span class="o">.</span><span class="n">tensor</span><span class="p">(</span><span class="mf">4.0</span><span class="p">)</span>
<span class="p">)</span>
<span class="n">rbf</span> <span class="o">=</span> <span class="n">gp</span><span class="o">.</span><span class="n">kernels</span><span class="o">.</span><span class="n">RBF</span><span class="p">(</span>
    <span class="n">input_dim</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">lengthscale</span><span class="o">=</span><span class="n">torch</span><span class="o">.</span><span class="n">tensor</span><span class="p">(</span><span class="mf">0.5</span><span class="p">),</span> <span class="n">variance</span><span class="o">=</span><span class="n">torch</span><span class="o">.</span><span class="n">tensor</span><span class="p">(</span><span class="mf">0.5</span><span class="p">)</span>
<span class="p">)</span>
<span class="n">k1</span> <span class="o">=</span> <span class="n">gp</span><span class="o">.</span><span class="n">kernels</span><span class="o">.</span><span class="n">Product</span><span class="p">(</span><span class="n">kern0</span><span class="o">=</span><span class="n">rbf</span><span class="p">,</span> <span class="n">kern1</span><span class="o">=</span><span class="n">periodic</span><span class="p">)</span>

<span class="n">k</span> <span class="o">=</span> <span class="n">gp</span><span class="o">.</span><span class="n">kernels</span><span class="o">.</span><span class="n">Sum</span><span class="p">(</span><span class="n">linear</span><span class="p">,</span> <span class="n">k1</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
</section>
</section>
<section id="remarks">
<h2><span class="section-number">5.4. </span>Remarks<a class="headerlink" href="#remarks" title="Permalink to this heading">#</a></h2>
<ul class="simple">
<li><p>If you have to apply Gaussian Processes to large datasets, or the training is too slow for your liking, take a look at <strong>Sparse Gaussian Processes</strong>. This class of Gaussian Processes seeks to avoid the computational constraints of traditional Gaussian Processes.</p></li>
</ul>
</section>
<section id="tasks">
<h2><span class="section-number">5.5. </span>Tasks<a class="headerlink" href="#tasks" title="Permalink to this heading">#</a></h2>
<p><strong>Methods of Inference and the Computational Cost of Methods</strong></p>
<ul class="simple">
<li><p>Explore the use of other inference methods to infer the hyperparameters of the Gaussian Processes Regression with Monte Carlo-style algorithms as youâ€™ve encountered earlier in the course</p>
<ul>
<li><p>Measure the difference in computational cost between the three approaches</p></li>
</ul>
</li>
<li><p>Repeat the same task for Gaussian Process Classification</p></li>
</ul>
<p><strong>Kernel Choices</strong></p>
<ul class="simple">
<li><p>Experiment with the different combinations of the different kernels, visualize the combinations, and consider for which kind of function you would potentially use them</p></li>
<li><p>Inspect the performance of your constructed kernels for GP Regression</p></li>
<li><p>Repeat the same task for Gaussian Process Classification</p></li>
</ul>
</section>
</section>

    <script type="text/x-thebe-config">
    {
        requestKernel: true,
        binderOptions: {
            repo: "binder-examples/jupyter-stacks-datascience",
            ref: "master",
        },
        codeMirrorConfig: {
            theme: "abcdef",
            mode: "python"
        },
        kernelOptions: {
            name: "python3",
            path: "./exercise"
        },
        predefinedOutput: true
    }
    </script>
    <script>kernelName = 'python3'</script>

                </article>
              

              
              
              
              
                <footer class="prev-next-footer">
                  
<div class="prev-next-area">
    <a class="left-prev"
       href="svm.html"
       title="previous page">
      <i class="fa-solid fa-angle-left"></i>
      <div class="prev-next-info">
        <p class="prev-next-subtitle">previous</p>
        <p class="prev-next-title"><span class="section-number">4. </span>Support Vector Machines</p>
      </div>
    </a>
    <a class="right-next"
       href="cnn.html"
       title="next page">
      <div class="prev-next-info">
        <p class="prev-next-subtitle">next</p>
        <p class="prev-next-title"><span class="section-number">6. </span>Convolutional Neural Networks</p>
      </div>
      <i class="fa-solid fa-angle-right"></i>
    </a>
</div>
                </footer>
              
            </div>
            
            
              
                <div class="bd-sidebar-secondary bd-toc"><div class="sidebar-secondary-items sidebar-secondary__inner">

  <div class="sidebar-secondary-item">
  <div class="page-toc tocsection onthispage">
    <i class="fa-solid fa-list"></i> Contents
  </div>
  <nav class="bd-toc-nav page-toc">
    <ul class="visible nav section-nav flex-column">
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#tl-dr-of-gaussian-process-theory">5.1. Tl;dr of Gaussian Process Theory</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#gaussian-processes-from-sketch">5.2. Gaussian Processes from Sketch</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#gaussian-processes-in-pyro">5.3. Gaussian Processes in Pyro</a><ul class="nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#helper-function-for-plotting">5.3.1. Helper Function for Plotting</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#synthetic-dataset">5.3.2. Synthetic Dataset</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#model-definition">5.3.3. Model Definition</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#inference">5.3.4. Inference</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#maximum-a-posteriory-estimation-map">5.3.5. Maximum a Posteriory Estimation (MAP)</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#gaussian-process-classification">5.3.6. Gaussian Process Classification</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#gaussian-process-classification-the-tl-dr">5.3.7. Gaussian Process Classification: The tl;dr</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#combining-kernels">5.3.8. Combining Kernels</a></li>
</ul>
</li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#remarks">5.4. Remarks</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#tasks">5.5. Tasks</a></li>
</ul>
  </nav></div>

</div></div>
              
            
          </div>
          <footer class="bd-footer-content">
            
<div class="bd-footer-content__inner container">
  
  <div class="footer-item">
    
<p class="component-author">
By N. Adams, L. Paehler, A. Toshev
</p>

  </div>
  
  <div class="footer-item">
    

  <p class="copyright">
    
      Â© Copyright 2022,2023,2024.
      <br/>
    
  </p>

  </div>
  
  <div class="footer-item">
    
  </div>
  
  <div class="footer-item">
    
  </div>
  
</div>
          </footer>
        

      </main>
    </div>
  </div>
  
  <!-- Scripts loaded after <body> so the DOM is not blocked -->
  <script src="../_static/scripts/bootstrap.js?digest=5b4479735964841361fd"></script>
<script src="../_static/scripts/pydata-sphinx-theme.js?digest=5b4479735964841361fd"></script>

  <footer class="bd-footer">
  </footer>
  </body>
</html>